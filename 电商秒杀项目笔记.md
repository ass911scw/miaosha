



# 电商秒杀项目

![image-20210309202858036](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309202858036.png)



## 一、项目的创建

### 1.1、新建maven项目

File -> New -> Project，选择maven项目，JDK1.8，勾选create from archetype，选择maven-archetype-quickstart。

指定src/main/java包为sources root，新建resources包，指定为Resources root,指定src/test包为test resources root

### 1.2、引入SpringBoot依赖

在pom.xml中的properties标签前引入依赖

```xml
  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.4.2</version>
    <relativePath/> <!-- lookup parent from repository -->
  </parent>
```

在dependencies标签内部引入依赖

```xml
<dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
```

在APP类上加入注解@EnableAutoConfiguration，开启自动配置

测试

在APP类上加入注解@RestController，并实现一个hello接口

```java
@RequestMapping("/")
    public String home(){
        return "hello";
}
```

打开浏览器，访问localhost:8080，页面如下

![image-20210306193619470](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306193619470.png)

### 1.3、集成mybatis

在resources目录下，新建application.properties文件作为配置文件，在配置文件中可以修改Tomcat的端口号，数据库连接的配置，数据源配置，mapper扫描等

在pom.xml中引入mysql，druid的依赖以及springboot对mybatis的支持

```xml
<dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>5.1.41</version>
    </dependency>
    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>druid</artifactId>
      <version>1.1.3</version>
    </dependency>
    <dependency>
      <groupId>org.mybatis.spring.boot</groupId>
      <artifactId>mybatis-spring-boot-starter</artifactId>
      <version>1.3.1</version>
    </dependency>
```

在application.properties指定mapper-locations

```properties
mybatis.mapper-locations=classpath:mapping/*.xml
```

classpath就是resources目录，所以我们在resources目录下新建mapping目录，在mapping目录中创建对于DAO层mapper接口的xml文件

在pom.xml的plugins标签内中引入自动生成xml代码的插件mybatis-generator

```xml
<plugin>
          <groupId>org.mybatis.generator</groupId>
          <artifactId>mybatis-generator-maven-plugin</artifactId>
          <version>1.3.5</version>
          <dependencies>
            <dependency>
              <groupId>org.mybatis.generator</groupId>
              <artifactId>mybatis-generator-core</artifactId>
              <version>1.3.5</version>
            </dependency>

            <dependency>
              <groupId>mysql</groupId>
              <artifactId>mysql-connector-java</artifactId>
              <version>5.1.41</version>
            </dependency>
          </dependencies>
          <executions>
            <execution>
              <id>mybatis generator</id>
              <phase>package</phase>
              <goals>
                <goal>generate</goal>
              </goals>
            </execution>
          </executions>
          <configuration>
            <!---允许移动生成的文件-->
            <verbose>true</verbose>
            <!---允许自动覆盖文件-->
            <overwrite>false</overwrite>
            <configurationFile>
              src/main/resources/mybatis-generator.xml
            </configurationFile>
          </configuration>
        </plugin>
```

### 1.4、数据库的创建及mybatis-generator的使用

下载Navicat用于可视化Mysql

新建数据库miaosha，字符集为UTF-8，编码方式使用Unicode。

在数据库中建两张表，user_info和user_password

user_info表：

![image-20210306195356125](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306195356125.png)

int类型的默认值为0，varchar类型的默认值为''

user_password表：

![image-20210306195509602](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306195509602.png)



在resources目录下新建mybatis-generator.xml文件，内容如下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"
        >
<generatorConfiguration >
    <context id="DB2Tables" targetRuntime="MyBatis3">
        <!--数据库链接地址账号密码-->
        <jdbcConnection driverClass="com.mysql.jdbc.Driver"
                        connectionURL="jdbc:mysql://127.0.0.1:3306/miaosha" userId="root" password="root">
        </jdbcConnection>
        <!-- 生成DataObject类存放位置-->
        <javaModelGenerator targetPackage="com.miaoshaproject.dataobject" targetProject="src/main/java">
            <property name="enableSubPackages" value="true" />
            <property name="trimStrings" value="true" />
        </javaModelGenerator>

        <!--生成映射文件存放位置-->
        <sqlMapGenerator targetPackage="mapping" targetProject="src/main/resources">
            <property name="enableSubPackages" value="true"/>
        </sqlMapGenerator>

        <!--生成Dao类存放位置-->
        <javaClientGenerator type="XMLMAPPER" targetPackage="com.miaoshaproject.dao"
                             targetProject="src/main/java">
            <property name="enableSubPackages" value="true"/>
        </javaClientGenerator>

        <!--生成对应表及类名-->
        <table tableName="user_info" domainObjectName="UserDO" enableCountByExample="false"
               enableUpdateByExample="false"  enableDeleteByExample="false"
               enableSelectByExample="false"  selectByExampleQueryId="false"></table>

        <table tableName="user_password" domainObjectName="UserPasswordDO" enableCountByExample="false"
               enableUpdateByExample="false"  enableDeleteByExample="false"
               enableSelectByExample="false"  selectByExampleQueryId="false"></table>
    </context>
</generatorConfiguration>
```

jdbcConnection标签中的connectionURL属性指定我们要连接的数据库

javaModelGenerator标签中的targetPackage属性指定自动生成的dataobject的存放包，targetProject属性指定生成的目录

sqlMapGenerator标签中的targetPackage属性指定自动生成的mapping.xml文件的存放包，targetProject属性指定生成的目录

javaClientGenerator标签中的targetPackage属性指定自动生成的mapper接口的存放包，targetProject属性指定生成的目录

table标签中tableName属性对应数据库中的表名，domainObjectName属性指定要生成的数据库表对应的实体类的类名，其余属性指定为flase（用不到）

在com.miaoshaproject目录下新建dao目录和dataobject目录

run->edit configuration，点+新建maven，配置如下

![image-20210306200538403](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306200538403.png)

run mybatis-generator

运行后生成以下文件

![image-20210306200707240](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306200707240.png)

![image-20210306200716717](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306200716717.png)

![image-20210306200727177](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306200727177.png)

在APP类中，将@EnableAutoConfiguration注解更改为@SpringBootApplication(scanBasePackages = {"com.miaoshaproject"})，说明APP被spring托管并指定APP为主启动类。将扫描范围设置为整个项目。添加注解@MapperScan("com.miaoshaproject.dao")，指定mapper存放的位置

##### **问题**（未解决）

![image-20210306201128068](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306201128068.png)

这里会报错，但是编译执行都不影响（原因？？？）

## 二、用户模块开发

### 2.1、使用springMVC的方法开发用户信息

#### 2.1.1、Controller层开发

在com.miaoshaproject目录下新建controller目录和service目录，在controller目录下新建UserController，添加注解

```java
@Controller("user")
@RequestMapping("/user")
```

指定该类为controller层，并且通过localhost/端口号/user访问

方法gerUser，调用service层的getUserById方法，通过id返回通用对象

```java
@RequestMapping("/get")
    @ResponseBody
    public CommonRetrunType gerUser(@RequestParam(name="id") Integer id) throws BusinessException {
        //调用service层的服务获取对应id的用户对象并返回给前端页面
        UserModel userModel = userService.getUserById(id);

        if (userModel == null){
            throw new BusinessException(EmBusinessError.USER_NOT_EXIST);
        }
        //将核心领域模型转换为可供UI使用的viewobjext
        UserVO userVO = convertFormModel(userModel);
        //返回通用对象
        return CommonRetrunType.create(userVO);
    }
public UserModel convertFromDataObject(UserDO userDO, UserPasswordDO userPasswordDO){
        if (userDO == null){
            return null;
        }
        UserModel userModel = new UserModel();
        BeanUtils.copyProperties(userDO,userModel);
        if (userPasswordDO != null){
            //userModel中的id与userPasswordDO中的id意义不同，直接使用copyProperties会出现问题，因此使用set方法
            userModel.setEncrptPassword(userPasswordDO.getEncrptPassword());
        }

        return userModel;
}
```

#### 2.1.2、Service开发

在service目录中新建UserService接口，并新建UserServiceImpl类

在UserService类中声明getUserById方法

```java
 UserModel getUserById(Integer id);
```

在UserServiceImpl中实现,在UserServiceImpl加@Service注解，在UserServiceImpl中声明UserPasswordDOMapper对象，调用selectByUserId方法

```java
@Service
public class UserServiceImpl implements UserService{
    @Autowired
    private UserDOMapper userDOMapper; 
    
    @Autowired
	private UserPasswordDOMapper userPasswordDOMapper;

@Override
    public UserModel getUserById(Integer id) {
        //通过id获取对应的用户对象信息
        UserDO userDO = userDOMapper.selectByPrimaryKey(id);
        if (userDO == null){
            return null;
        }
        //通过用户id获得对应的加密密码信息
        UserPasswordDO userPasswordDO = userPasswordDOMapper.selectByUserId(userDO.getId());
        return convertFromDataObject(userDO,userPasswordDO);
    }
}
```

#### 2.1.3、Dao层开发

userDOMapper.xml中有自动生成的selectByPrimaryKey方法，因此直接调用就可以获得userDO对象

由于UserPasswordDoMapper.xml中没有生成通过userId获取对象的sql语句，因此我们需要自己加入

```xml
<select id="selectByUserId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 03 08:24:46 CST 2021.
    -->
    select
    <include refid="Base_Column_List" />
    from user_password
    where user_id = #{userId,jdbcType=INTEGER}
  </select>
```

在UserPasswordDOMapper接口中声明selectByUserId方法

```java
UserPasswordDO selectByUserId(Integer userId);
```

#### 2.1.4、3层架构对应3种数据类型

在开发中UserDo类型的对象是不能够直接暴露给用户的，因此在service层，必须有一个model的概念。在service目录下，新建model目录，新建UserModel类。UserModel类不仅还有UserDo对象中的属性，还有UserPasswordDo对象中的encrptPassword属性。

```java
public class UserModel {
    private Integer id;
    private String name;
    private Integer gender;
    private Integer age;
    private String telephone;
    private String registerMode;
    private String thirdPartyId;

    private String encrptPassword;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getGender() {
        return gender;
    }

    public void setGender(Integer gender) {
        this.gender = gender;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    public String getTelephone() {
        return telephone;
    }

    public void setTelephone(String telephone) {
        this.telephone = telephone;
    }

    public String getRegisterMode() {
        return registerMode;
    }

    public void setRegisterMode(String registerMode) {
        this.registerMode = registerMode;
    }

    public String getThirdPartyId() {
        return thirdPartyId;
    }

    public void setThirdPartyId(String thirdPartyId) {
        this.thirdPartyId = thirdPartyId;
    }

    public String getEncrptPassword() {
        return encrptPassword;
    }

    public void setEncrptPassword(String encrptPassword) {
        this.encrptPassword = encrptPassword;
    }
}
```

在model对象中，有用户加密的密码信息，这也不能直接返回给controller层，因此我们还需要在controller目录下新建viewobject目录，并新建类UserVO

```java
public class UserVO {
    private Integer id;
    private String name;
    private Integer gender;
    private Integer age;
    private String telephone;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getGender() {
        return gender;
    }

    public void setGender(Integer gender) {
        this.gender = gender;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    public String getTelephone() {
        return telephone;
    }

    public void setTelephone(String telephone) {
        this.telephone = telephone;
    }
}
```

总结

Dao层------UserDO，UserPasswordDO------直接对应数据库中的表，由mybatis-generator生成

Service层------UserModel------数据库表中的所有字段，通过convertFromDataObject方法把UserDO，UserPasswordDO对象组装得到

Controller层------UserVO------可以展示给用户，不冗余，不暴露隐私的字段，通过convertFormModel方法把UserModel对象转换得到

#### 2.1.5、通用的返回对象

每一个不同的请求，都根据其返回值来解析对应的json字符串，对前端是不友好的

我们需要一归一化处理一些异常的错误

因此我们需要定义通用的返回对象

在com.miaoshaproject目录下新建response目录，定义CommonRetrunType类

```java
package com.miaoshaproject.response;

public class CommonRetrunType {

    //表明对应请求的返回处理结果是success或fail
    private String status;

    //若status=success，data内返回前端需要的json数据
    //若status=fail，data内返回通用的错误码格式
    private Object data;

    public static CommonRetrunType create(Object data){
        return CommonRetrunType.create(data,"success");
    }

    public static CommonRetrunType create(Object data,String status){
        CommonRetrunType type = new CommonRetrunType();
        type.setData(data);
        type.setStatus(status);
        return type;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

}

```

2.1.6、测试结果

在user_info表中加入一条记录

![image-20210306211122406](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306211122406.png)

在浏览器中输入localhost:8090/user/get?id=1

得到结果如下

![image-20210306211230968](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210306211230968.png)

### 2.2、异常处理

#### 2.2.1、定义通用错误形式

在com.miaoshaproject目录下新建error目录，在error目录下定义CommonError接口

```java
package com.miaoshaproject.error;

public interface CommonError {
    int getErrorCode();
    String getErrorMsg();
    CommonError setErrorMsg(String msg);
}
```

定义枚举EmBusinessError类实现CommonError接口

```java
package com.miaoshaproject.error;

public enum EmBusinessError implements CommonError{
    //通用错误类型
    PARAMETER_VAILDATION_ERROR(10001,"参数不合法"),
    UNKNOWN_ERROR(10002,"未知错误"),
    //20000开头为用户信息相关错误定义
    USER_NOT_EXIST(20001,"用户不存在"),
    USER_LOGIN_FAIL(20002,"用户手机号或密码不正确")
    ;

    private int errCode;
    private String errMsg;

    private EmBusinessError(int errCode, String errMsg){
        this.errCode = errCode;
        this.errMsg = errMsg;
    }
    @Override
    public int getErrorCode() {
        return this.errCode;
    }

    @Override
    public String getErrorMsg() {
        return this.errMsg;
    }

    @Override
    public CommonError setErrorMsg(String msg) {
        this.errMsg = msg;
        return this;
    }
}

```

定义BusinessException继承Exception类，实现CommonError接口

```java
package com.miaoshaproject.error;

//包装器业务异常类实现
public class BusinessException extends Exception implements CommonError{
    private CommonError commonError;

    //直接接受EmBusinessError的传参用于构造业务异常
    public BusinessException(CommonError commonError){
        super();
        this.commonError = commonError;
    }

    //接收自定义的errMsg的方式构造业务异常
    public BusinessException(CommonError commonError, String errMsg){
        super();
        this.commonError = commonError;
        this.commonError.setErrorMsg(errMsg);
    }

    @Override
    public int getErrorCode() {
        return this.commonError.getErrorCode();
    }

    @Override
    public String getErrorMsg() {
        return this.commonError.getErrorMsg();
    }

    @Override
    public CommonError setErrorMsg(String msg) {
        this.commonError.setErrorMsg(msg);
        return this;
    }
}

```

#### 2.2.2、定义exceptionhandler解决未被controller层吸收的异常

由于异常处理是所以controller都需要实现的功能，因此定义BaseController类实现exceptionhandler方法，让其他的controller继承BaseController

```java
public class BaseController {
    public static final String CONTENT_TYPE_FORMED="application/x-www-form-urlencoded";
    //定义exceptionhandler解决未被controller层吸收的异常
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public Object handlerException(HttpServletRequest httpServletRequest, Exception ex){
        Map<String, Object> responseData = new HashMap<>();
        if (ex instanceof BusinessException){
            BusinessException businessException = (BusinessException) ex;
            responseData.put("errCode",businessException.getErrorCode());
            responseData.put("errMsg",businessException.getErrorMsg());
        }else {
            responseData.put("errCode", EmBusinessError.UNKNOWN_ERROR.getErrorCode());
            responseData.put("errMsg",EmBusinessError.UNKNOWN_ERROR.getErrorMsg());
        }
        return CommonRetrunType.create(responseData,"fail");
    }
}
```

当controller中throw new BusinessException()时，就会进入handlerException()中

若在调用getUser方法时，查询出来的UserModel==null，它会抛出java.lang.NullPointException，然后通过SpringBoot的注解

```
@ExceptionHandler(Exception.class)
```

进行拦截，然后自定义处理。

### 2.3、otp验证码获取

功能：用户在前端页面的输入框中输入手机号，获取验证码。若输入正确，前端页面中提示“otp已经发送到了您的手机上，请注意查收”，否则返回发送失败及原因。

```java
	@Autowired
    private HttpServletRequest request;    
//用户获取otp短信接口
    @RequestMapping(value = "/getotp",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType getOtp(@RequestParam(name="telephone") String telephone){
        //按照一定的规则生成otp验证码
        Random random = new Random();
        int randomInt = random.nextInt(99999);//生成[0,bound)区间内的int型随机数
        randomInt += 10000;//随机数范围变为[10000,109999)
        String otpCode = String.valueOf(randomInt);
        //将otp验证码和用户手机号关联,使用httpsession的方式绑定用户手机号和otpCode
        request.getSession().setAttribute(telephone,otpCode);
        //将otp验证码通过短信发送给用户（省略）
        System.out.println("telephone:"+telephone+" otpCode:"+otpCode);

        return CommonRetrunType.create(null);
    }
```

getOtp方法将用户的手机号与random.nextInt()生成的otp验证码存入HttpServletRequest类型的request对象的session中保存，以便在之后的注册功能中判断用户输入的otp验证码与手机号绑定的otp验证码是否一致。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
    <div class="content">
        <h3 class="form-title">获取otp信息</h3>
        <div class="form-group">
            <label class="control-label">手机号</label>
            <div>
                <input class="form-control" type="text" placeholder="手机号" name="telephone" id="telephone">
            </div>
            <div class="form-actions">
                <button class="btn blue" id="getotp" type="submit">
                    获取otp短信
                </button>
            </div>
        </div>


    </div>
</body>

<script>
    jQuery(document).ready(function () {
        //绑定发送otp的click事件，用于向后端发送获取手机验证码的请求
        $("#getotp").on("click",function () {
            var telephone = $("#telephone").val();
            if (telephone == null || telephone == ""){
                alert("手机号不能为空");
                return false;
            }
            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/user/getotp",
                data:{
                    "telephone":$("#telephone").val(),
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("otp已经发送到了您的手机上，请注意查收");
                        window.location.href="http://localhost:63342/miaosha/register.html?_ijt=puadib0pdm4vlc2me6cjsd9gdl";
                    }else {
                        alert("otp发送失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("otp发送失败，原因为"+data.responseText);
                }
            })
        })
        return false;
    });
</script>
</html>
```

其中

```html
<script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
```

引入jQuery

```html
<link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
<link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
```

引入bootstrap样式

```html
 jQuery(document).ready(function (){});
```

保证在页面渲染完成后才能执行操作

```html
$("#getotp").on("click",function () )
```

id选择器$.('#对应id')；on方法绑定一个或多个事件处理程序

```html
$.ajax({
               	type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/user/getotp",
                data:{
                    "telephone":$("#telephone").val(),
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("otp已经发送到了您的手机上，请注意查收");
                        window.location.href="http://localhost:63342/miaosha/register.html?_ijt=puadib0pdm4vlc2me6cjsd9gdl";
                    }else {
                        alert("otp发送失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("otp发送失败，原因为"+data.responseText);
                }
            })
```

type: 规定请求的类型（GET 或 POST）。

contentType：发送数据到服务器时所使用的内容类型。默认是："application/x-www-form-urlencoded"。

url：规定发送请求的 URL。默认为当前页面。

data：规定要发送到服务器的数据。

xhrFields：一个具有多个"字段名称-字段值"对的对象，用于对本地XHR对象进行设置。一对「文件名-文件值」在本机设置XHR对象。		withCredentials属性为true实现跨域访问

​		在UserController上加注解,解决跨域问题

```java
@CrossOrigin(originPatterns = "*", allowCredentials = "true", allowedHeaders = "*")
```

@CrossOrigin注解中，会有问题：spring2.4版本，allowCreadentials 为 true不允许后面的设置* ，加上originPatterns = "*"问题解决；或者将spring版本改为2.0版本

DEFALUT_ALLOWED_HEADERS:允许跨域传输所有的header参数，将用于使用token放入header域，做session共享的跨域请求

DEFALUT_ALLOW_CREDENTIALS=true:配合前端设置的xhrFields授信后使得跨域session共享



success：当请求成功时运行的函数。

error：如果请求失败要运行的函数。

windows.location.href="/url"： 当前页面打开URL页面，并提交数据

return false表示阻止浏览器对事件的默认处理

最终效果

![image-20210307143025356](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210307143025356.png)

### 2.4、用户注册功能

#### 2.4.1、Controller层开发

```java
 //用户注册接口
    @RequestMapping(value = "/register",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType register(@RequestParam(name="telephone") String telephone,
                                     @RequestParam(name="otpCode") String otpCode,
                                     @RequestParam(name="name") String name,
                                     @RequestParam(name="gender") Integer gender,
                                     @RequestParam(name="age") Integer age,
                                     @RequestParam(name="password") String password) throws BusinessException, UnsupportedEncodingException, NoSuchAlgorithmException {
        //验证手机号和对应的otpCode相符合
        String inSessionOtpCode = (String) request.getSession().getAttribute(telephone);
        //这个equals方法内部实现了判空操作
        if (!StringUtils.equals(inSessionOtpCode,otpCode)){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"短信验证码不符合");
        }
        //用户注册流程
        UserModel userModel = new UserModel();
        userModel.setName(name);
        userModel.setAge(age);
        userModel.setGender(gender);
        userModel.setTelephone(telephone);
        userModel.setRegisterMode("byphone");
        //对密码进行加密
        userModel.setEncrptPassword(this.EncodeByMd5(password));
        userService.regiser(userModel);
        return CommonRetrunType.create(null);
    }
    public String EncodeByMd5(String str) throws UnsupportedEncodingException, NoSuchAlgorithmException {
        //确定计算方法
        MessageDigest md5 = MessageDigest.getInstance("MD5");
        BASE64Encoder base64Encoder = new BASE64Encoder();
        //加密字符串
        String newStr = base64Encoder.encode(md5.digest(str.getBytes("utf-8")));
        return newStr;
    }
```

使用java自带的MD5加密会出问题，因此自定义加密方法

com.alibaba.druid.utils.StringUtils中的equals方法内部实现了判空操作

```java
    public static boolean equals(String a, String b) {
        if (a == null) {
            return b == null;
        } else {
            return a.equals(b);
        }
    }
```

#### 2.4.2、Service层开发

在pom.xml中导入依赖，这个依赖中的StringUtils帮助我们校验userModel中的值是否合法

```xml
<dependency>
      <groupId>org.apache.commons</groupId>
      <artifactId>commons-lang3</artifactId>
      <version>3.7</version>
    </dependency>
```



```java
@Override
    @Transactional
    public void regiser(UserModel userModel) throws BusinessException{
        if (userModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR);
        }
        if (StringUtils.isEmpty(userModel.getName()) ||
            userModel.getGender() == null ||
            userModel.getAge() == null ||
            StringUtils.isEmpty(userModel.getTelephone())){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR);
        }
        UserDO userDO = convertFromUserModel(userModel);
		userDOMapper.insertSelective(userDO);
        userModel.setId(userDO.getId());
        UserPasswordDO userPasswordDO = convertPasswordFromUserModel(userModel);
        userPasswordDOMapper.insertSelective(userPasswordDO);
    }
//将UserModel中的信息组装成UserPasswordDO
    private UserPasswordDO convertPasswordFromUserModel(UserModel userModel){
        if (userModel == null){
            return null;
        }
        UserPasswordDO userPasswordDO = new UserPasswordDO();
        //userModel中的id与userPasswordDO中的id意义不同，直接使用copyProperties会出现问题，因此使用set方法
        userPasswordDO.setUserId(userModel.getId());
        userPasswordDO.setEncrptPassword(userModel.getEncrptPassword());
        return userPasswordDO;
    }
//将UserModel中的信息组装成UserDO
    private UserDO convertFromUserModel(UserModel userModel){
        if (userModel == null){
            return null;
        }
        UserDO userDO = new UserDO();
        BeanUtils.copyProperties(userModel,userDO);
        return userDO;
    }
```

userModel.setId(userDO.getId());十分重要，user_info表的id字段和user_password的user_id字段是相关联的，在userModel对象被存入表中时，id字段会自动递增，此时将id赋值给userPasswordDO。否则user_password表中，user_id会为null

```xml
<insert id="insertSelective" parameterType="com.miaoshaproject.dataobject.UserDO" keyProperty="id" useGeneratedKeys="true">
    insert into user_info
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="name != null">
        name,
      </if>
      <if test="gender != null">
        gender,
      </if>
      <if test="age != null">
        age,
      </if>
      <if test="telephone != null">
        telephone,
      </if>
      <if test="registerMode != null">
        register_mode,
      </if>
      <if test="thirdPartyId != null">
        third_party_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="gender != null">
        #{gender,jdbcType=INTEGER},
      </if>
      <if test="age != null">
        #{age,jdbcType=INTEGER},
      </if>
      <if test="telephone != null">
        #{telephone,jdbcType=VARCHAR},
      </if>
      <if test="registerMode != null">
        #{registerMode,jdbcType=VARCHAR},
      </if>
      <if test="thirdPartyId != null">
        #{thirdPartyId,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
```

insertSelective会判断对应的字段在dataobject中是否为null，如果为null则跳过，如果不为null则执行insert操作。这样的好处是，如果要插入的字段为null，在数据库中该字段的默认值为0，则insertSelective方法不会用null覆盖0，在表中，该字段的值还是0.

```java
 @Transactional
```

@Transactional注解：spring的事务控制。防止userDO对象插入成功而userPasswordDO对象插入失败后造成数据不一致的情况

#### 2.4.3、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">用户注册</h3>
    <div class="form-group">
        <label class="control-label">手机号</label>
        <div>
            <input class="form-control" type="text" placeholder="手机号" name="telephone" id="telephone">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">验证码</label>
        <div>
            <input class="form-control" type="text" placeholder="验证码" name="otpCode" id="otpCode">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">用户昵称</label>
        <div>
            <input class="form-control" type="text" placeholder="用户昵称" name="name" id="name">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">性别</label>
        <div>
            <input class="form-control" type="text" placeholder="性别" name="gender" id="gender">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">年龄</label>
        <div>
            <input class="form-control" type="text" placeholder="年龄" name="age" id="age">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">密码</label>
        <div>
            <input class="form-control" type="password" placeholder="密码" name="password" id="password">
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="register" type="submit">
            提交注册
        </button>
    </div>


</div>
</body>

<script>
    jQuery(document).ready(function () {
        //绑定发送otp的click事件，用于向后端发送获取手机验证码的请求
        $("#register").on("click",function () {
            var telephone = $("#telephone").val();
            var otpCode = $("#otpCode").val();
            var name = $("#name").val();
            var age = $("#age").val();
            var gender = $("#gender").val();
            var password = $("#password").val();

            if (otpCode == null || otpCode == ""){
                alert("验证码不能为空");
                return false;
            }
            if (name == null || name == ""){
                alert("用户昵称不能为空");
                return false;
            }
            if (age == null || age == ""){
                alert("年龄不能为空");
                return false;
            }
            if (gender == null || gender == ""){
                alert("性别不能为空");
                return false;
            }
            if (password == null || password == ""){
                alert("密码不能为空");
                return false;
            }
            if (telephone == null || telephone == ""){
                alert("手机号不能为空");
                return false;
            }

            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/user/register",
                data:{
                    "telephone":$("#telephone").val(),
                    "otpCode":otpCode,
                    "name":name,
                    "age":age,
                    "gender":gender,
                    "password":password,
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("注册成功");
                    }else {
                        alert("注册失败，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("注册失败，原因为"+data.responseText);
                }
            })
        })
        return false;
    });
</script>
</html>
```

register.html与getotp.html类似，如果网络出现原因，可能走到error的function中

为了防止1个用户用同样的手机号注册2次，在user_info表中把telephone字段设置成唯一索引

![image-20210307155832955](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210307155832955.png)

注册成功后，结果如下：

user_info表

![image-20210307155928284](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210307155928284.png)

user_password表

![image-20210307155946787](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210307155946787.png)

### 2.5、用户登录功能

#### 2.5.1、Controller层开发

```java
//用户登录接口
    @RequestMapping(value = "/login",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType login(@RequestParam(name="telephone") String telephone,
                                  @RequestParam(name="password") String password) throws BusinessException, UnsupportedEncodingException, NoSuchAlgorithmException {

        //入参校验，用户手机号和密码不能为空
        if (org.apache.commons.lang3.StringUtils.isEmpty(telephone) ||
                org.apache.commons.lang3.StringUtils.isEmpty(password)){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR);
        }

        //用户登录
        UserModel userModel = userService.vaildateLogin(telephone,this.EncodeByMd5(password));

        //将登录凭证加到用户登录成功的session内
        this.request.getSession().setAttribute("IS_LOGIN",true);
        this.request.getSession().setAttribute("LOGIN_USER",userModel);
        return CommonRetrunType.create(null);
}
```





#### 2.5.2、Service层开发

在UserService接口中声明vaildateLogin方法，用来校验用户入参是否合法

```java
UserModel vaildateLogin(String telephone, String encrptPassword) throws BusinessException;
```

在UserServiceImpl中实现

```java
//用户登录
    @Override
    public UserModel vaildateLogin(String telephone, String encrptPassword) throws BusinessException {
        //通过用户的手机号查询用户信息
        UserDO userDO = userDOMapper.selectByTelephone(telephone);
        if (userDO == null){
            throw new BusinessException(EmBusinessError.USER_LOGIN_FAIL);
        }
        UserPasswordDO userPasswordDO = userPasswordDOMapper.selectByUserId(userDO.getId());
        UserModel userModel = convertFromDataObject(userDO,userPasswordDO);
        //比对用户传进来的密码是否与数据库中的密码相匹配
        if (!StringUtils.equals(encrptPassword,userModel.getEncrptPassword())){
            throw new BusinessException(EmBusinessError.USER_LOGIN_FAIL);
        }
        return userModel;

}
```



#### 2.5.3、Dao层开发

在UserDOMapper.xml中加入selectByTelephone方法，通过手机号获取用户信息

```xml
<select id="selectByTelephone"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 03 08:24:46 CST 2021.
    -->
    select
    <include refid="Base_Column_List" />
    from user_info
    where telephone = #{telephone,jdbcType=VARCHAR}
  </select>
```

并在UserDOMapper接口中声明

```java
UserDO selectByTelephone(String telephone);
```



#### 2.5.4、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">用户登录</h3>
    <div class="form-group">
        <label class="control-label">手机号</label>
        <div>
            <input class="form-control" type="text" placeholder="手机号" name="telephone" id="telephone">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">密码</label>
        <div>
            <input class="form-control" type="password" placeholder="密码" name="password" id="password">
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="login" type="submit">
            登录
        </button>
        <button class="btn green" id="register" type="submit">
            注册
        </button>
    </div>


</div>
</body>

<script>
    jQuery(document).ready(function () {
        $("#register").on("click",function (){
            window.location.href="http://localhost:63342/miaosha/getotp.html?_ijt=q0fmcrig6dafs7q1jcl1mmj3ni";
        });
        //绑定发送otp的click事件，用于向后端发送获取手机验证码的请求
        $("#login").on("click",function () {
            var telephone = $("#telephone").val();
            var password = $("#password").val();
            if (password == null || password == ""){
                alert("密码不能为空");
                return false;
            }
            if (telephone == null || telephone == ""){
                alert("手机号不能为空");
                return false;
            }

            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/user/login",
                data:{
                    "telephone":$("#telephone").val(),
                    "password":password,
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("登录成功");
                    }else {
                        alert("登录失败，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("登录失败，原因为"+data.responseText);
                }
            })
        })
        return false;
    });
</script>
</html>
```

结果如下

![image-20210307161726752](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210307161726752.png)

### 2.6、优化校验规则

在pom.xml中引入hibernate-validator依赖

```xml
   <dependency>
      <groupId>org.hibernate</groupId>
      <artifactId>hibernate-validator</artifactId>
      <version>5.2.4.Final</version>
    </dependency>
```

在com.miaoshaproject新建validator包，实现两个类ValidationResult和ValidatorImpl

```java
package com.miaoshaproject.validator;

import org.apache.commons.lang3.StringUtils;

import java.util.HashMap;
import java.util.Map;

public class ValidationResult {
    //校验结果是否有错
    private boolean hasError = false;
    //存放错误信息的map
    Map<String,String> errorMsgMap = new HashMap<>();

    public boolean isHasError() {
        return hasError;
    }

    public void setHasError(boolean hasError) {
        this.hasError = hasError;
    }

    public Map<String, String> getErrorMsgMap() {
        return errorMsgMap;
    }

    public void setErrorMsgMap(Map<String, String> errorMsgMap) {
        this.errorMsgMap = errorMsgMap;
    }

    public String getErrMsg(){
        return StringUtils.join(errorMsgMap.values().toArray(),",");
    }

}

```

getErrMsg()方法实现通用的通过格式化字符串信息获取错误结果

```java
package com.miaoshaproject.validator;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.stereotype.Component;

import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import java.util.Set;


@Component
public class ValidatorImpl implements InitializingBean {
    private Validator validator;

    //实现校验方法并返回校验结果
    public ValidationResult vaildate(Object bean){
        ValidationResult validationResult = new ValidationResult();
        Set<ConstraintViolation<Object>> constraintViolationSet = validator.validate(bean);
        if (constraintViolationSet.size() > 0){
            //有错误
            validationResult.setHasError(true);
            constraintViolationSet.forEach(constraintViolation ->{
                String errMsg = constraintViolation.getMessage();
                String propertyName = constraintViolation.getPropertyPath().toString();
                validationResult.getErrorMsgMap().put(propertyName,errMsg);
            });
        }
        return validationResult;
    }

    @Override
    public void afterPropertiesSet() throws Exception {
        //将hibernate库的validator通过工厂的初始化方式使其实例化
        this.validator = Validation.buildDefaultValidatorFactory().getValidator();
    }
}

```

在UserModel中定义字段的限制信息

```java
package com.miaoshaproject.service.model;

import org.hibernate.validator.constraints.NotBlank;

import javax.validation.constraints.Max;
import javax.validation.constraints.Min;
import javax.validation.constraints.NotNull;

public class UserModel {
    private Integer id;
    @NotBlank(message = "用户名不能为空")
    private String name;

    @NotNull(message = "性别不能不填")
    private Integer gender;

    @NotNull(message = "年龄不能不填")
    @Min(value = 0,message = "年龄必须大于0")
    @Max(value = 150,message = "年龄必须小于150")
    private Integer age;

    @NotBlank(message = "手机号不能为空")
    private String telephone;


    private String registerMode;
    private String thirdPartyId;

    @NotBlank(message = "密码不能为空")
    private String encrptPassword;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getGender() {
        return gender;
    }

    public void setGender(Integer gender) {
        this.gender = gender;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    public String getTelephone() {
        return telephone;
    }

    public void setTelephone(String telephone) {
        this.telephone = telephone;
    }

    public String getRegisterMode() {
        return registerMode;
    }

    public void setRegisterMode(String registerMode) {
        this.registerMode = registerMode;
    }

    public String getThirdPartyId() {
        return thirdPartyId;
    }

    public void setThirdPartyId(String thirdPartyId) {
        this.thirdPartyId = thirdPartyId;
    }

    public String getEncrptPassword() {
        return encrptPassword;
    }

    public void setEncrptPassword(String encrptPassword) {
        this.encrptPassword = encrptPassword;
    }
}

```

**注意**

@NotBlank是org.hibernate.validator.constraints中的，限制不能为空且不能为null

@NotNull，@Min，@Max是javax.validation.constraints中的

如果导错包会出问题！

在UserServiceImpl中修改代码,引入ValidatorImpl对象并且修改regiser方法中的校验代码

```java
    @Autowired
    private ValidatorImpl validator;

//用户注册
    @Override
    @Transactional
    public void regiser(UserModel userModel) throws BusinessException{
        if (userModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR);
        }
//        if (StringUtils.isEmpty(userModel.getName()) ||
//            userModel.getGender() == null ||
//            userModel.getAge() == null ||
//            StringUtils.isEmpty(userModel.getTelephone())){
//            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR);
//        }
        ValidationResult result = validator.vaildate(userModel);
        if (result.isHasError()){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,result.getErrMsg());
        }
        UserDO userDO = convertFromUserModel(userModel);
        try{
            userDOMapper.insertSelective(userDO);
        }catch (DuplicateKeyException ex){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"手机号不能重复注册");
        }

        userModel.setId(userDO.getId());
        UserPasswordDO userPasswordDO = convertPasswordFromUserModel(userModel);
        userPasswordDOMapper.insertSelective(userPasswordDO);
    }
```

## 三、商品模块开发

### 3.1、商品创建

在com.miaoshaproject.service.model包下新建itemModel类

```java
public class ItemModel {
    private Integer id;

    //商品名称
    @NotBlank(message = "商品名称不能为空")
    private String title;

    //商品价格
    @NotNull(message = "商品价格不能为空")
    @Min(value = 0 ,message = "商品价格必须大于0")
    private BigDecimal price;

    //商品库存
    @NotNull(message = "库存不能不填")
    private Integer stock;

    //商品描述
    @NotBlank(message = "商品描述信息不能为空")
    private String description;

    //商品销量
    private Integer sales;

    //商品图片
    @NotBlank(message = "图片不能为空")
    private String imgUrl;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public BigDecimal getPrice() {
        return price;
    }

    public void setPrice(BigDecimal price) {
        this.price = price;
    }

    public Integer getStock() {
        return stock;
    }

    public void setStock(Integer stock) {
        this.stock = stock;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public Integer getSales() {
        return sales;
    }

    public void setSales(Integer sales) {
        this.sales = sales;
    }

    public String getImgUrl() {
        return imgUrl;
    }

    public void setImgUrl(String imgUrl) {
        this.imgUrl = imgUrl;
    }
}
```

在数据库中新建2张表，item表和item_stock表

item表

![image-20210308171302982](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308171302982.png)

item_stock表

![image-20210308171329635](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308171329635.png)

在mybatis-generator.xml中，**把之前自动生成userDO和userPasswordDO的xml代码注释掉**

生成ItemDO和ItemStockDO两个实体类，ItemDOMapper.java,ItemStockDOMapper.java两个Mapper接口以及ItemDOMapper.xml，ItemStockDOMapper.xml，在两个xml文件的insert和insertSelective方法中加入

```xml
useGeneratedKeys="true" keyProperty="id"
```

**保证id的自增**

在com.miaoshaproject.controller.viewobject包下新建ItemVO类

```java
public class ItemVO {
    private Integer id;

    //商品名称
    private String title;

    //商品价格
    private BigDecimal price;

    //商品库存
    private Integer stock;

    //商品描述
    private String description;

    //商品销量
    private Integer sales;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public BigDecimal getPrice() {
        return price;
    }

    public void setPrice(BigDecimal price) {
        this.price = price;
    }

    public Integer getStock() {
        return stock;
    }

    public void setStock(Integer stock) {
        this.stock = stock;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public Integer getSales() {
        return sales;
    }

    public void setSales(Integer sales) {
        this.sales = sales;
    }

    public String getImgUrl() {
        return imgUrl;
    }

    public void setImgUrl(String imgUrl) {
        this.imgUrl = imgUrl;
    }

    //商品图片
    private String imgUrl;
}
```

**一定要写get、set方法**，否则在controller层调用service层方法获取itemModel对象后，转为itemVO对象会为null，尽管数据库中有数据，但是前端页面会报错！

总结

与用户数据类型类似

Dao层------ItemDO，ItemStockDO------直接对应数据库中的表，由mybatis-generator生成

Service层------ItemModel------数据库表中的所有字段，通过convertItemModelFromDataObject方法把ItemDO，ItemStockDO对象组装得到

Controller层------ItemVO------可以展示给用户，不冗余，不暴露隐私的字段，通过convertItemVOFromModel方法把UserModel对象转换得到

### 3.2、创建商品功能

在com.miaoshaproject.controller包下新建itemController，继承baseController。提供创建商品，商品详情浏览以及商品列表浏览3个接口

#### 3.2.1、Controller层开发

```java
    @Autowired
    private ItemService itemService;

    //创建商品的接口
    @RequestMapping(value = "/create",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType createItem(@RequestParam(name = "title") String title,
                                       @RequestParam(name = "description") String description,
                                       @RequestParam(name = "price") BigDecimal price,
                                       @RequestParam(name = "imgUrl") String imgUrl,
                                       @RequestParam(name = "stock") Integer stock
                                       ) throws BusinessException {
        ItemModel itemModel = new ItemModel();
        itemModel.setTitle(title);
        itemModel.setPrice(price);
        itemModel.setDescription(description);
        itemModel.setStock(stock);
        itemModel.setImgUrl(imgUrl);

        ItemModel itemModelForReturn  = itemService.createItem(itemModel);
        ItemVO itemVO = this.convertItemVOFromModel(itemModelForReturn);
        return CommonRetrunType.create(itemVO);
    }

    private ItemVO convertItemVOFromModel(ItemModel itemModel){
        if (itemModel == null){
            return null;
        }
        ItemVO itemVO = new ItemVO();
        BeanUtils.copyProperties(itemModel,itemVO);
        return itemVO;
    }

```



#### 3.2.2、Service层开发

```java
@Override
    @Transactional
    public ItemModel createItem(ItemModel itemModel) throws BusinessException {
        //校验入参
        ValidationResult result =  validator.vaildate(itemModel);
        if (result.isHasError()){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,result.getErrMsg());
        }
        //转化ItemModel -> ItemDO
        ItemDO itemDO = new ItemDO();
        itemDO = this.convertItemDOFromItemModel(itemModel);
        //将itemDO对象存入item表
        itemDOMapper.insertSelective(itemDO);

        //获取itemModel的id
        itemModel.setId(itemDO.getId());
        //转化ItemModel -> ItemStockDO
        ItemStockDO itemStockDO = this.convertItemStockDOFromItemModel(itemModel);
        //将ItemStockDO对象存入item_stock表
        itemStockDOMapper.insertSelective(itemStockDO);
        //返回创建完成的对象
        return this.getItemById(itemModel.getId());
}
```

将controller层传来的ItemModel进行校验，之后封装itemDO和ItemStockDO对象，通过

```java
itemModel.setId(itemDO.getId());
```

将item表的id和item_stock表的item_id关联起来



#### 3.2.3、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">创建商品</h3>
    <div class="form-group">
        <label class="control-label">商品名</label>
        <div>
            <input class="form-control" type="text" placeholder="商品名" name="title" id="title">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <input class="form-control" type="text" placeholder="商品描述" name="description" id="description">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">价格</label>
        <div>
            <input class="form-control" type="text" placeholder="价格" name="price" id="price">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">图片</label>
        <div>
            <input class="form-control" type="text" placeholder="图片" name="imgUrl" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">库存</label>
        <div>
            <input class="form-control" type="text" placeholder="库存" name="stock" id="stock">
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="create" type="submit">
            提交创建
        </button>
    </div>


</div>
</body>

<script>
    jQuery(document).ready(function () {

        $("#create").on("click",function () {
            var title = $("#title").val();
            var description = $("#description").val();
            var price = $("#price").val();
            var imgUrl = $("#imgUrl").val();
            var stock = $("#stock").val();


            if (title == null || title == ""){
                alert("商品名不能为空");
                return false;
            }
            if (description == null || description == ""){
                alert("商品描述不能为空");
                return false;
            }
            if (price == null || price == ""){
                alert("价格不能为空");
                return false;
            }
            if (imgUrl == null || imgUrl == ""){
                alert("图片URL不能为空");
                return false;
            }
            if (stock == null || stock == ""){
                alert("库存不能为空");
                return false;
            }

            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/item/create",
                data:{
                    "title":title,
                    "description":description,
                    "price":price,
                    "imgUrl":imgUrl,
                    "stock":stock,
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("创建成功");
                    }else {
                        alert("创建失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("创建失败，原因为"+data.responseText);
                }
            })
        })
        return false;
    });
</script>
</html>
```

创建成功后结果如下：

![image-20210308173756102](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308173756102.png)



![image-20210308173809093](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308173809093.png)

**如果创建失败，一定要删除脏数据，否则会因为item表的id与item_stock表的item_id不一致而报错！**

### 3.3、商品详情页浏览功能

#### 3.3.1、Controller层开发

```java
//商品详情页浏览
    @RequestMapping(value = "/get",method = {RequestMethod.GET})
    @ResponseBody
    public CommonRetrunType getItem(@RequestParam(name = "id") Integer id){
        ItemModel itemModel = itemService.getItemById(id);
        ItemVO itemVO = this.convertItemVOFromModel(itemModel);
        return CommonRetrunType.create(itemVO);
    }
```

getItem方法不会在content-type上加任何的信息，如果设置了consumes = {CONTENT_TYPE_FORMED})会报错

![image-20210308200527858](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308200527858.png)



#### 3.3.2、Service层开发

```java
@Override
    public ItemModel getItemById(Integer id) {
        ItemDO itemDO = itemDOMapper.selectByPrimaryKey(id);
        if (itemDO == null){
            return null;
        }
        //操作获得库存数量
        ItemStockDO itemStockDO = itemStockDOMapper.selectByItemId(itemDO.getId());
        //将itemDO和itemStockDO封装为ItemModel
        ItemModel itemModel = this.convertItemModelFromDataObject(itemDO,itemStockDO);
        return itemModel;
    }
```



#### 3.3.3、Dao层开发

在ItemStockDOMapper.xml中添加selectByItemId方法

```xml
<select id="selectByItemId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Feb 04 11:23:51 CST 2019.
    -->
    select
    <include refid="Base_Column_List" />
    from item_stock
    where item_id = #{itemId,jdbcType=INTEGER}
  </select>
```

在ItemStockDOMapper接口中声明

```java
ItemStockDO selectByItemId(Integer id);
```

#### 3.3.4、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">商品详情</h3>
    <div class="form-group">
        <label class="control-label">商品名</label>
        <div>
            <label class="control-label" id="title"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <label class="control-label" id="description"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">价格</label>
        <div>
            <label class="control-label" id="price"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">图片</label>
        <div>
            <img style="width: 200px;height: auto" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">库存</label>
        <div>
            <label class="control-label" id="stock"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">销量</label>
        <div>
            <label class="control-label" id="sales"/>
        </div>
    </div>


</div>
</body>

<script>
    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null),paramValue
    }
    var g_itemVO = {};
    jQuery(document).ready(function () {
        //获取商品详情
            $.ajax({
                type:"GET",
                url:"http://localhost:8090/item/get",
                data:{
                    "id":getParam("id"),

                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        g_itemVO = data.data;
                        reloadDom();
                    }else {
                        alert("获取信息失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("获取信息失败，原因为"+data.responseText);
                }
            })

        return false;
    });
    function reloadDom() {
        $("#title").text(g_itemVO.title);
        $("#description").text(g_itemVO.description);
        $("#stock").text(g_itemVO.stock);
        $("#price").text(g_itemVO.price);
        $("#imgUrl").attr("src",g_itemVO.imgUrl);
        $("#sales").text(g_itemVO.sales);
    }
</script>
</html>
```

**问题：javascript代码看不懂**

结果如下

![image-20210308202739865](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308202739865.png)



### 3.4、商品列表页面浏览功能

#### 3.4.1、Controller层开发

```java
@RequestMapping(value = "/list",method = {RequestMethod.GET})
    @ResponseBody
    public CommonRetrunType listItem(){
        List<ItemModel> itemModels = itemService.listItem();
        //使用Stream api将List<ItemModel>转化为List<ItemVO>
        List<ItemVO> itemVOS = itemModels.stream().map(itemModel -> {
            ItemVO itemVO = this.convertItemVOFromModel(itemModel);
            return itemVO;
        }).collect(Collectors.toList());
        return CommonRetrunType.create(itemVOS);
    }
```

这段代码使用了java8的stream api，Stream 是 Java8 中处理集合的关键抽象概念，它可以指定你希望对集合进行的操作，可以执行非常复杂的查找、过滤和映射数据等操作。

map：接收一个函数作为参数，该函数会被应用到每个元素上，并将其映射成一个新的元素。itemModel相当于函数的形参，对于itemModels这个list中的每个元素，都执行->{}中的代码。

collect：接收一个Collector实例，将流中元素收集成另外一个数据结构。将itemVO放到新的list中。

```java
List<ItemVO> itemVOS = itemModels.stream().map(itemModel -> {
            ItemVO itemVO = this.convertItemVOFromModel(itemModel);
            return itemVO;
}).collect(Collectors.toList());
```

这段代码相当于

```java
List<ItemVO> itemVOS = new ArrayList();
for(int i = 0; i < itemModels.size(); i++){
    ItemVO itemVO = this.convertItemVOFromModel(itemModels.get(i));
    itemVOS.add(itemVO);
}
```

#### 3.4.2、Service层开发

```java
@Override
    public List<ItemModel> listItem() {
        List<ItemDO> itemDOList = itemDOMapper.listItem();
        List<ItemModel> itemModels = itemDOList.stream().map(itemDO -> {
            ItemStockDO itemStockDO = itemStockDOMapper.selectByItemId(itemDO.getId());
            ItemModel itemModel = this.convertItemModelFromDataObject(itemDO,itemStockDO);
            return itemModel;
        }).collect(Collectors.toList());
        return itemModels;
    }
```

#### 3.4.3、Dao层开发

在ItemDOMapper.xml中添加listItem方法，把所有的数据按照商品销量降序排列

```xml
<select id="listItem"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 08 11:21:30 CST 2021.
    -->
    select
    <include refid="Base_Column_List" />
    from item
    order by sales DESC ;
  </select>
```

在ItemDOMapper接口中声明listItem方法

```java
List<ItemDO> listItem();
```

#### 3.4.4、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body >
<div class="content">
    <h3 class="form-title">商品列表浏览</h3>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>商品名</th>
                    <th>商品图片</th>
                    <th>商品描述</th>
                    <th>商品价格</th>
                    <th>商品库存</th>
                    <th>商品销量</th>
                </tr>
            </thead>
            <tbody id="container">

            </tbody>
        </table>
    </div>



</div>
</body>

<script>
    //定义全局商品信息数组
    var g_itemList = [];
    jQuery(document).ready(function () {
            $.ajax({
                type:"GET",
                url:"http://localhost:8090/item/list",
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        g_itemList = data.data;
                        reloadDom();
                    }else {
                        alert("获取商品信息失败，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("获取商品信息失败，原因为"+data.responseText);
                }
            });

        
    });
function reloadDom() {
    for (var i = 0; i < g_itemList.length; i++) {
        var itemVO = g_itemList[i];
        var dom="<tr data-id='"+itemVO.id+"' id='itemDetail"+itemVO.id+"'><td>"+
            itemVO.title+"</td><td><img style='width: 100px;height:auto' src='"+
            itemVO.imgUrl+"'/></td><td>" +
            itemVO.description+"</td><td>"+
            itemVO.price+"</td><td>"+
            itemVO.stock+"</td><td>"+
            itemVO.sales+"</td></tr>";
        $("#container").append($(dom));

        $("#itemDetail"+itemVO.id).on("click",function (e) {
            window.location.href="getitem.html?id="+$(this).data("id");
        });
    }
}
</script>
</html>
```

通过鼠标点击商品列表中的名称跳转到对应的商品详情页面

```html
$("#itemDetail"+itemVO.id).on("click",function (e) {
            window.location.href="getitem.html?id="+$(this).data("id");
});
```

结果如下

![image-20210308202624038](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308202624038.png)

点击iPhone后跳转

![image-20210308202650461](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210308202650461.png)

## 四、交易模块开发

### 4.1、交易模型创建

在com.miaoshaproject.service.model下新建OrderModel类

```java
public class OrderModel {
    //交易订单号
    private String id;

    //交易用户id
    private Integer userId;

    //商品id
    private Integer itemId;

    //购买商品的单价
    private BigDecimal itemPrice;

    //购买数量
    private Integer amount;

    //购买金额
    private BigDecimal orderPrice;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public Integer getUserId() {
        return userId;
    }

    public void setUserId(Integer userId) {
        this.userId = userId;
    }

    public Integer getItemId() {
        return itemId;
    }

    public void setItemId(Integer itemId) {
        this.itemId = itemId;
    }

    public BigDecimal getItemPrice() {
        return itemPrice;
    }

    public void setItemPrice(BigDecimal itemPrice) {
        this.itemPrice = itemPrice;
    }

    public Integer getAmount() {
        return amount;
    }

    public void setAmount(Integer amount) {
        this.amount = amount;
    }

    public BigDecimal getOrderPrice() {
        return orderPrice;
    }

    public void setOrderPrice(BigDecimal orderPrice) {
        this.orderPrice = orderPrice;
    }

} 
```

在数据库中新建order_info表

![image-20210309161439227](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309161439227.png)

使用mybaits-generator生成OrderDO类，OrderDOMapper接口和OrderDOMapper.xml文件

```xml
<table tableName="order_info" domainObjectName="OrderDO" enableCountByExample="false"
               enableUpdateByExample="false"  enableDeleteByExample="false"
               enableSelectByExample="false"  selectByExampleQueryId="false"></table>
```

### 4.2、交易下单功能

#### 4.2.1、Controller层开发

```java
public class OrderController extends BaseController{
    @Autowired
    private OrderService orderService;

    @Autowired
    private HttpServletRequest httpServletRequest;

    //封装下单请求
    @RequestMapping(value = "/createorder",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType createOrder(@RequestParam(name = "itemId")Integer itemId,
                                        @RequestParam(name = "amount")Integer amount,
                                        )Integer promoId) throws BusinessException {

        Boolean isLogin = (Boolean) httpServletRequest.getSession().getAttribute("IS_LOGIN");
        if (isLogin == null || !isLogin){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        //获取用户登录信息
        UserModel userModel = (UserModel) httpServletRequest.getSession().getAttribute("LOGIN_USER");
        OrderModel orderModel = orderService.createModel(userModel.getId(),itemId,amount);

        return CommonRetrunType.create(null);
    }
}
```



#### 4.2.2、Service层开发

新建orderService接口

```java
public interface OrderService {
    OrderModel createModel(Integer userId, Integer itemId, Integer amount) throws BusinessException;
}
```

OrderServiceImpl类

```java
@Service
public class OrderServiceImpl implements OrderService {
    @Autowired
    private ItemService itemService;

    @Autowired
    private UserService userService;

    @Autowired
    private OrderDOMapper orderDOMapper;

    @Autowired
    private SequenceDOMapper sequenceDOMapper;

    @Autowired
    private OrderService orderService;

    @Override
    @Transactional
    public OrderModel createModel(Integer userId, Integer itemId, Integer amount) throws BusinessException {
        //1、校验下单状态，用户是否合法，商品是否存在，购买数量是否正确
        ItemModel itemModel = itemService.getItemById(itemId);
        if (itemModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"商品信息不存在");
        }
        UserModel userModel = userService.getUserById(userId);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"用户信息不存在");
        }
        if (amount <= 0 || amount >99){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"数量信息不正确");
        }
     

        //2、落单减库存
        boolean result = itemService.decreaseStock(itemId,amount);
        if (!result){
            throw new BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }

        //3、订单入库
        OrderModel orderModel = new OrderModel();
        orderModel.setItemId(itemId);
        orderModel.setUserId(userId);
        orderModel.setAmount(amount);
        
        orderModel.setItemPrice(itemModel.getPrice());
        

        
        orderModel.setOrderPrice(orderModel.getItemPrice().multiply(new BigDecimal(amount)));
        //生成交易订单号
        orderModel.setId(generateOrderId());
        OrderDO orderDO = this.convertOrderDOFromOrderModel(orderModel);
        orderDOMapper.insertSelective(orderDO);
        //商品销量增加
        itemService.increaseSales(itemId,amount);
        //4、返回前端
        return orderModel;
    }

    private OrderDO convertOrderDOFromOrderModel(OrderModel orderModel){
        if (orderModel == null){
            return null;
        }
        OrderDO orderDO = new OrderDO();
        BeanUtils.copyProperties(orderModel,orderDO);
        //在数据库中这两个字段是double类型，在model中是BigDecimal类型
        //不转换的话数据库中无法插入数据
        orderDO.setItemPrice(orderModel.getItemPrice().doubleValue());
        orderDO.setOrderPrice(orderModel.getOrderPrice().doubleValue());
        return orderDO;
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public String generateOrderId(){
        //订单号有16位
        StringBuilder stringBuilder = new StringBuilder();

        //前8位是时间信息，年月日
        LocalDateTime now = LocalDateTime.now();
        String nowDate = now.format(DateTimeFormatter.ISO_DATE).replace("-","");
        stringBuilder.append(nowDate);

        //中间6位为自增序列
        int sequence = 0;
        SequenceDO sequenceDO = sequenceDOMapper.getSequenceByName("order_info");
        sequence = sequenceDO.getCurrentValue();
        sequenceDO.setCurrentValue(sequence + sequenceDO.getStep());
        sequenceDOMapper.updateByPrimaryKeySelective(sequenceDO);
        String sequenceStr = String.valueOf(sequence);
        for (int i = 0; i < 6 - sequenceStr.length(); i++) {//假设自增部分不会超过6位
            stringBuilder.append(0);
        }
        stringBuilder.append(sequenceStr);

        //最后2位为分库分表位，暂时写死
        stringBuilder.append("00");

        return stringBuilder.toString();
    }
}

```

在itemService中声明

```java
	//库存扣减
    boolean decreaseStock(Integer itemId, Integer amount) throws BusinessException;

    //销量增加
    void increaseSales(Integer itemId, Integer amount) throws BusinessException;
```

itemServiceImpl实现

```java
 @Override
    @Transactional
    public boolean decreaseStock(Integer itemId, Integer amount) throws BusinessException {
        int affectedRow = itemStockDOMapper.decreaseStock(itemId,amount);
        if (affectedRow > 0){
            //更新库存成功
            return true;
        }else {
            //更新库存失败
            return false;
        }
    }

    @Override
    @Transactional
    public void increaseSales(Integer itemId, Integer amount) throws BusinessException {
        itemDOMapper.increaseSales(itemId, amount);
    }
```

对于generateOrderId()方法来说

要使得@Transactional生效，必须通过JDK动态代理或者CGLIB来调用B方法，而不能直接在A方法中调用B方法，

这里可以在OrderServiceImpl中注入自身：

```java
@Autowired
private OrderService orderService;
```

在createOrder()方法中这样调用：

```java
orderModel.setId(orderService.generateOrderId());
```

当然，generateOrderNo()方法要改成public，OrderService接口中也要申明下generateOrderNo()方法。

因此，OrderService修改如下，在原有的基础上添加String generateOrderId()方法

```java
public interface OrderService {
    OrderModel createModel(Integer userId, Integer itemId, Integer promoId, Integer amount) throws BusinessException;

    String generateOrderId();
}
```



#### 4.2.3、Dao层开发

在itemService声明的decreaseStock方法

在itemStockDOMapper接口中声明

```java
int decreaseStock(@Param("itemId")Integer itemId, @Param("amount")Integer amount);
```

在itemStockDOMapper.xml中实现

```xml
  <update id="decreaseStock" >
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 08 11:21:30 CST 2021.
    -->
    update item_stock
    set stock = stock - #{amount}
    where item_id = #{itemId} and stock > #{amount}
  </update>
```



在itemService声明的increaseSales方法

```java
int increaseSales(@Param("id") Integer id, @Param("amount")Integer amount);
```

在itemDOMapper接口中声明

```xml
<update id="increaseSales" >
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 08 11:21:30 CST 2021.
    -->
    update item
    set sales = sales + #{amount}
    where id = #{id}
  </update>
```

**这两个方法中，set语句最后不能加“,“否则会报错**



为了实现OrderServiceImpl中的generateOrderId方法，我们在数据库中新建sequence_info表，来生成交易订单号的中间的6位自增序列。初始sequence的值是0，每多一条订单信息，就加step

![image-20210309171327048](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309171327048.png)

在表中直接添加一条数据

![image-20210309171522100](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309171522100.png)



在mybaits-generator中添加

```xml
<table tableName="sequence_info" domainObjectName="SequenceDO" enableCountByExample="false"
               enableUpdateByExample="false"  enableDeleteByExample="false"
               enableSelectByExample="false"  selectByExampleQueryId="false"></table>
```

在SequenceDOMapper接口中声明方法

```java
 SequenceDO getSequenceByName(String name);
```

在SequenceDOMapper.xml中实现

```xml
<select id="getSequenceByName" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Mar 09 09:30:10 CST 2021.
    -->
    select
    <include refid="Base_Column_List" />
    from sequence_info
    where name = #{name,jdbcType=VARCHAR} for update
  </select>
```



#### 4.2.4、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">商品详情</h3>
    <div class="form-group">
        <label class="control-label">商品名</label>
        <div>
            <label class="control-label" id="title"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <label class="control-label" id="description"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">价格</label>
        <div>
            <label class="control-label" id="price"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">图片</label>
        <div>
            <img style="width: 200px;height: auto" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">库存</label>
        <div>
            <label class="control-label" id="stock"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">销量</label>
        <div>
            <label class="control-label" id="sales"/>
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="createorder" type="submit">
            下单
        </button>
    </div>

</div>
</body>

<script>
    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null),paramValue
    }
    var g_itemVO = {};
    jQuery(document).ready(function () {
        $("#createorder").on("click", function () {
            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/order/createorder",
                data:{
                    "itemId":g_itemVO.id,
                    "amount":1,
                    "promoId":g_itemVO.promoId
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("下单成功！");
                        //刷新界面
                        window.location.reload();
                    }else {
                        alert("下单失败，原因为"+data.data.errMsg );
                        if (data.data.errCode == 20003){
                            window.location.href = "login.html";
                        }

                    }
                },
                error:function (data) {
                    alert("下单失败，原因为"+data.responseText);
                }
            })
        });
        //获取商品详情
            $.ajax({
                type:"GET",
                url:"http://localhost:8090/item/get",
                data:{
                    "id":getParam("id"),

                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        g_itemVO = data.data;
                        reloadDom();
                  
                    }else {
                        alert("获取信息失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("获取信息失败，原因为"+data.responseText);
                }
            })

        return false;
    });
    function reloadDom() {
        $("#title").text(g_itemVO.title);
        $("#description").text(g_itemVO.description);
        $("#stock").text(g_itemVO.stock);
        $("#price").text(g_itemVO.price);
        $("#imgUrl").attr("src",g_itemVO.imgUrl);
        $("#sales").text(g_itemVO.sales);
       
    }
</script>
</html>
```

## 五、秒杀模块开发

由于秒杀活动是和商品以及交易相关的功能，原有的代码也会出现一定的改动。有的商品参加了秒杀活动，对应的商品信息中要添加秒杀活动信息。由于秒杀活动的价格会发生变化，因此交易模块也会发生改变。

### 5.1、活动模型创建

promoModel模型

```java
public class PromoModel {
    private Integer id;

    //秒杀活动名称
    private String promoName;

    //秒杀活动状态 1表示还未开始，2表示正在进行中，3表示已经结束
    private Integer status;


    //秒杀活动的开始时间
    private DateTime startDate;

    //秒杀活动的结束时间
    private DateTime endDate;

    //秒杀活动的适用商品
    private Integer itemId;

    //秒杀活动的商品价格
    private BigDecimal prompItemPrice;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getPromoName() {
        return promoName;
    }

    public void setPromoName(String promoName) {
        this.promoName = promoName;
    }

    public DateTime getStartDate() {
        return startDate;
    }

    public void setStartDate(DateTime startDate) {
        this.startDate = startDate;
    }

    public Integer getItemId() {
        return itemId;
    }

    public void setItemId(Integer itemId) {
        this.itemId = itemId;
    }

    public BigDecimal getPrompItemPrice() {
        return prompItemPrice;
    }

    public void setPrompItemPrice(BigDecimal prompItemPrice) {
        this.prompItemPrice = prompItemPrice;
    }

    public DateTime getEndDate() {
        return endDate;
    }

    public void setEndDate(DateTime endDate) {
        this.endDate = endDate;
    }

    public Integer getStatus() {
        return status;
    }

    public void setStatus(Integer status) {
        this.status = status;
    }
}
```

promo表

![image-20210309192426621](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309192426621.png)



在pom.xml中添加joda-time依赖，startDate和endDate均为joda-time类型

```xml
    <dependency>
      <groupId>joda-time</groupId>
      <artifactId>joda-time</artifactId>
      <version>2.9.1</version>
    </dependency>
```



itemModel也需要增加promoModel属性

```java
//使用聚合模型，如果promoModel不为空，则说明这个商品存在还未结束的秒杀活动
    private PromoModel promoModel;

    public PromoModel getPromoModel() {
        return promoModel;
    }

    public void setPromoModel(PromoModel promoModel) {
        this.promoModel = promoModel;
    }
```

参与秒杀活动的商品需要在前端页面展示给用户，因此itemVO也需要增加属性

```java
 //记录商品是否在秒杀活动中，0表示没有秒杀活动，1表示秒杀活动待开始，2表示秒杀活动正在进行
    private Integer promoStatus;

    //秒杀活动价格
    private BigDecimal promoPrice;

    //秒杀活动ID
    private Integer promoId;

    //秒杀活动开始时间
    private String startDate;

public Integer getPromoStatus() {
        return promoStatus;
    }

    public void setPromoStatus(Integer promoStatus) {
        this.promoStatus = promoStatus;
    }

    public BigDecimal getPromoPrice() {
        return promoPrice;
    }

    public void setPromoPrice(BigDecimal promoPrice) {
        this.promoPrice = promoPrice;
    }

    public Integer getPromoId() {
        return promoId;
    }

    public void setPromoId(Integer promoId) {
        this.promoId = promoId;
    }

    public String getStartDate() {
        return startDate;
    }

    public void setStartDate(String startDate) {
        this.startDate = startDate;
    }
```

OrderModel中添加promoId属性

```java
//若非空，则表示是以秒杀商品的方式下单
    private Integer promoId;

//购买商品的单价，若promoId非空，则表示秒杀商品价格
    private BigDecimal itemPrice;

//购买金额，若promoId非空，则表示购买秒杀商品金额
    private BigDecimal orderPrice;
```

order_info表的字段也需要更改，新增promo_id字段，对应的OrderDO,OrderDOMapper接口以及OrderDOMapper.xml也需要进行更改

![image-20210309202006221](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309202006221.png)



### 5.2、活动模型与商品模型结合

#### 5.2.1、Controller层开发

itemController需要进行更改

```java
 private ItemVO convertItemVOFromModel(ItemModel itemModel){
        if (itemModel == null){
            return null;
        }
        ItemVO itemVO = new ItemVO();
        BeanUtils.copyProperties(itemModel,itemVO);
        if (itemModel.getPromoModel() != null){
            //说明有正在进行或即将进行的秒杀活动
            itemVO.setPromoStatus(itemModel.getPromoModel().getStatus());
            itemVO.setPromoId(itemModel.getPromoModel().getId());
            itemVO.setStartDate(itemModel.getPromoModel().getStartDate().toString(DateTimeFormat.forPattern("yyyy-MM-dd HH:mm:ss")));
            itemVO.setPromoPrice(itemModel.getPromoModel().getPrompItemPrice());
        }else {
            itemVO.setPromoStatus(0);
        }
        return itemVO;
    }
```

orderController需要进行更改

```java 
//封装下单请求
    @RequestMapping(value = "/createorder",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType createOrder(@RequestParam(name = "itemId")Integer itemId,
                                        @RequestParam(name = "amount")Integer amount,
                                        @RequestParam(name = "promoId",required = false)Integer promoId) throws BusinessException {

        Boolean isLogin = (Boolean) httpServletRequest.getSession().getAttribute("IS_LOGIN");
        if (isLogin == null || !isLogin){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        //获取用户登录信息
        UserModel userModel = (UserModel) httpServletRequest.getSession().getAttribute("LOGIN_USER");
        OrderModel orderModel = orderService.createModel(userModel.getId(),itemId,promoId,amount);

        return CommonRetrunType.create(null);
    }
```



#### 5.2.2、Service层开发

```java
@Service
public class PromoServiceImpl implements PromoService {
    @Autowired
    private PromoDOMapper promoDOMapper;



    @Override
    public PromoModel getPromoByItemId(Integer itemId) {
        //获取对应商品的秒杀活动信息
        PromoDO promoDO = promoDOMapper.selectByItemId(itemId);
        PromoModel promoModel = this.convertPromoModelFromPromoDO(promoDO);
        if (promoModel == null){
            return null;
        }
        //判断当前时间秒杀活动是正在进行还是即将开始
        if (promoModel.getStartDate().isAfterNow()){//秒杀活动还未开始
            promoModel.setStatus(1);
        }else if (promoModel.getEndDate().isBeforeNow()){//秒杀活动已结束
            promoModel.setStatus(3);
        }else {//秒杀活动正在进行
            promoModel.setStatus(2);
        }
        return promoModel;
    }

    private PromoModel convertPromoModelFromPromoDO(PromoDO promoDO){
        if (promoDO == null){
            return null;
        }
        PromoModel promoModel = new PromoModel();
        BeanUtils.copyProperties(promoDO,promoModel);
        promoModel.setPrompItemPrice(new BigDecimal(promoDO.getPromoItemPrice()));
        promoModel.setStartDate(new DateTime(promoDO.getStartDate()));
        promoModel.setEndDate(new DateTime(promoDO.getEndDate()));
        return promoModel;
    }
}
```

itemServiceImpl的getItemById方法需要添加获取秒杀活动信息的处理

```java
@Override
    public ItemModel getItemById(Integer id) {
        ItemDO itemDO = itemDOMapper.selectByPrimaryKey(id);
        if (itemDO == null){
            return null;
        }
        //操作获得库存数量
        ItemStockDO itemStockDO = itemStockDOMapper.selectByItemId(itemDO.getId());
        //将itemDO和itemStockDO封装为ItemModel
        ItemModel itemModel = this.convertItemModelFromDataObject(itemDO,itemStockDO);
        //获取秒杀活动信息
        PromoModel promoModel = promoService.getPromoByItemId(itemModel.getId());
        if (promoModel != null && promoModel.getStatus().intValue() != 3){
            itemModel.setPromoModel(promoModel);
        }
        return itemModel;
    }

```



orderService接口中方法需要增加新的参数

```java
OrderModel createModel(Integer userId, Integer itemId, Integer promoId, Integer amount) throws BusinessException;
```



orderServiceImpl的createorder方法也需要更改

```java 
 @Override
    @Transactional
    public OrderModel createModel(Integer userId, Integer itemId, Integer promoId, Integer amount) throws BusinessException {
        //1、校验下单状态，用户是否合法，商品是否存在，购买数量是否正确
        ItemModel itemModel = itemService.getItemById(itemId);
        if (itemModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"商品信息不存在");
        }
        UserModel userModel = userService.getUserById(userId);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"用户信息不存在");
        }
        if (amount <= 0 || amount >99){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"数量信息不正确");
        }
        //校验活动信息
        if (promoId != null){
            //1、校验对应活动是否存在这个使用商品
            if (promoId.intValue() != itemModel.getPromoModel().getId()){
                throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"活动信息不正确");
            }else if (itemModel.getPromoModel().getStatus().intValue() != 2){//校验活动是否进行中
                throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"活动还未开始");
            }
        }

        //2、落单减库存
        boolean result = itemService.decreaseStock(itemId,amount);
        if (!result){
            throw new BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }

        //3、订单入库
        OrderModel orderModel = new OrderModel();
        orderModel.setItemId(itemId);
        orderModel.setUserId(userId);
        orderModel.setAmount(amount);
        if (promoId != null){
            orderModel.setItemPrice(itemModel.getPromoModel().getPrompItemPrice());
        }else {
            orderModel.setItemPrice(itemModel.getPrice());
        }

        orderModel.setPromoId(promoId);
        orderModel.setOrderPrice(orderModel.getItemPrice().multiply(new BigDecimal(amount)));
        //生成交易订单号
        orderModel.setId(generateOrderId());
        OrderDO orderDO = this.convertOrderDOFromOrderModel(orderModel);
        orderDOMapper.insertSelective(orderDO);
        //商品销量增加
        itemService.increaseSales(itemId,amount);
        //4、返回前端
        return orderModel;
    }
```





#### 5.2.3、Dao层开发

在PromoDaoMapper接口中声明

```java
PromoDO selectByItemId(Integer itemId);
```

在PromoDaoMapper.xml中实现

```xml
<select id="selectByItemId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from promo
    where item_id = #{itemId,jdbcType=INTEGER}
  </select>
```



#### 5.2.4、前端页面开发

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">商品详情</h3>
    <div id="promoStartDateContainer" class="form-group">
        <label style="color: blue" id="promoStatus" class="control-label"></label>
        <div>
            <label style="color: red" class="control-label" id="promoStartDate"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品名</label>
        <div>
            <label class="control-label" id="title"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <label class="control-label" id="description"/>
        </div>
    </div>
    <div id="normalPriceContainer" class="form-group">
        <label class="control-label">价格</label>
        <div>
            <label class="control-label" id="price"/>
        </div>
    </div>
    <div id="promoPriceContainer" class="form-group">
        <label style="color: red" class="control-label">秒杀价格</label>
        <div>
            <label style="color: red" class="control-label" id="promoPrice"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">图片</label>
        <div>
            <img style="width: 200px;height: auto" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">库存</label>
        <div>
            <label class="control-label" id="stock"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">销量</label>
        <div>
            <label class="control-label" id="sales"/>
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="createorder" type="submit">
            下单
        </button>
    </div>

</div>
</body>

<script>
    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null),paramValue
    }
    var g_itemVO = {};
    jQuery(document).ready(function () {
        $("#createorder").on("click", function () {
            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8090/order/createorder",
                data:{
                    "itemId":g_itemVO.id,
                    "amount":1,
                    "promoId":g_itemVO.promoId
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("下单成功！");
                        //刷新界面
                        window.location.reload();
                    }else {
                        alert("下单失败，原因为"+data.data.errMsg );
                        if (data.data.errCode == 20003){
                            window.location.href = "login.html";
                        }

                    }
                },
                error:function (data) {
                    alert("下单失败，原因为"+data.responseText);
                }
            })
        });
        //获取商品详情
            $.ajax({
                type:"GET",
                url:"http://localhost:8090/item/get",
                data:{
                    "id":getParam("id"),

                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        g_itemVO = data.data;
                        reloadDom();
                        setInterval(reloadDom,1000);
                    }else {
                        alert("获取信息失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("获取信息失败，原因为"+data.responseText);
                }
            })

        return false;
    });
    function reloadDom() {
        $("#title").text(g_itemVO.title);
        $("#description").text(g_itemVO.description);
        $("#stock").text(g_itemVO.stock);
        $("#price").text(g_itemVO.price);
        $("#imgUrl").attr("src",g_itemVO.imgUrl);
        $("#sales").text(g_itemVO.sales);
        if (g_itemVO.promoStatus == 1){
            //秒杀活动还未开始
            var startTime = g_itemVO.startDate.replace(new RegExp("-","gm"),"/");

            startTime = (new Date(startTime)).getTime();

            var nowTime = Date.parse(new Date());

            var delta = (startTime - nowTime) / 1000;


            if(delta<=0){
                //活动开始
                g_itemVO.promoStatus=2;
                reloadDom();
            }

            $("#promoStartDate").text("秒杀活动将于"+g_itemVO.startDate+"开始 倒计时："+delta+"秒");
            $("#promoPrice").text(g_itemVO.promoPrice);
            //活动没开始的话不允许下单
            $("#createorder").attr("disabled",true);
        }else if (g_itemVO.promoStatus == 2){
            //秒杀活动正在进行中
            $("#promoStartDate").text("秒杀正在进行中");
            $("#promoPrice").text(g_itemVO.promoPrice);
            //活动开始后可以下单
            $("#createorder").attr("disabled",false);
            $("#normalPriceContainer").hide();
        }
    }
</script>
</html>
```

结果如下

![image-20210309202810325](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210309202810325.png)

## 六、Linux环境下完善项目

### 6.1、压力测试

添加线程组

![image-20210314140235825](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314140235825.png)

添加http请求

![image-20210314140310857](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314140310857.png)

添加察看结果树

![image-20210314140415633](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314140415633.png)

添加聚合报告

![image-20210314140448752](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314140448752.png)

配置需要进行压力测试的接口



![image-20210314140554386](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314140554386.png)



压力测试示例：

线程数：

![image-20210314143911725](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314143911725.png)



聚合报告：

![image-20210314143933141](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314143933141.png)



参数说明

1、Lable：Label：每个 JMeter 的 element（例如 HTTP Request）都有一个 Name 属性，这里显示的就是 Name 属性的值；

2、#Samples:表示这次测试中一共发出了多少个请求

3、Average：平均响应时间——默认情况下是单个 Request 的平均响应时间，当使用了 Transaction Controller 时，也可以以Transaction 为单位显示平均响应时间；

4、Median：中位数，也就是 50％ 用户的响应时间；

5、90% Line ~ 99% Line：90％ ~99%用户的响应时间；

6、Min：最小响应时间；

7、Maximum：最大响应时间；

8、Error%：本次测试中出现的错误率，即 错误的请求的数量/请求的总数；

9、Throughput：吞吐量——默认情况下表示每秒完成的请求数（Request per Second）

10、Received KB/src：每秒从服务器端接收到的数据量；

11、Sent KB/src：每秒从客户端发送的请求的数量。

压力测试前系统线程数![image-20210314155848001](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314155848001.png)





压力测试中系统线程数![image-20210314155831411](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314155831411.png)



压测结果：![image-20210314160211355](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314160211355.png)



修改配置，

### 优化点1：**增加服务器端的并发线程**

```properties
server.port=80
server.tomcat.accept-count=1000
server.tomcat.max-threads=800
server.tomcat.min-spare-threads=100
```



压力测试前：

![image-20210314153332806](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314153332806.png)



压力测试中：![image-20210314153419265](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314153419265.png)

压测结果：![image-20210314154617334](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314154617334.png)

**疑惑：居然变的更差了。。。**



修改配置

```properties
server.port=80
server.tomcat.accept-count=1000
server.tomcat.max-threads=200
server.tomcat.min-spare-threads=100
```

结果

压力测试前：![image-20210314175301123](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314175301123.png)

压力测试中：![image-20210314175322223](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314175322223.png)

压测结果：

![image-20210314175206996](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314175206996.png)





**KeepAlive**

当客户端向服务器发送http请求时，若带上了含有KeepAlive的请求头，则表示客户端想和服务器之间建立一个KeepAlive的连接。在发送完响应后，服务器不要立刻断开连接，而是等待是否可以复用这个连接。这个可以解决每次http响应断开再连接的耗时问题。

![image-20210314165051465](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314165051465.png)

我的tomcat.max-connections是8192，tomcat.min-spare-threads没有显示默认值？

**定制化Tomcat开发**

配置KeepAlive相关参数



![image-20210314165935253](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210314165935253.png)



```java
package com.miaoshaproject.config;

import org.apache.catalina.connector.Connector;
import org.apache.coyote.http11.Http11AprProtocol;
import org.apache.coyote.http11.Http11NioProtocol;
import org.springframework.boot.web.embedded.tomcat.TomcatConnectorCustomizer;
import org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;
import org.springframework.boot.web.server.ConfigurableWebServerFactory;
import org.springframework.boot.web.server.WebServerFactoryCustomizer;
import org.springframework.stereotype.Component;

//当Spring容器内没有TomcatEmbeddedServletContainerFactory这个bean时，会把此bean加载金spring容器中
@Component
public class WebServerConfiguration implements WebServerFactoryCustomizer<ConfigurableWebServerFactory> {
    @Override
    public void customize(ConfigurableWebServerFactory factory) {
        // 使用对应工厂类提供给我们的接口定制化我们的tomcat connector
        ((TomcatServletWebServerFactory) factory).addConnectorCustomizers(new TomcatConnectorCustomizer() {
            @Override
            public void customize(Connector connector) {
                Http11NioProtocol protocol = (Http11NioProtocol) connector.getProtocolHandler();
                // 定制化keepAliveTimeout，设置30秒内没有请求则服务端自动断开keepalive链接
                protocol.setKeepAliveTimeout(300000);
                // 当客户端发送超过10000个请求则自动断开keepalive链接
                protocol.setMaxKeepAliveRequests(10000);
            }
        });
    }
}

```



### 优化点2：优化容量问题

线程数量：线程间进行切换也是很耗费cpu的

等待队列长度：队列作为缓冲池，不能无限长，消耗内存，出队入队也消耗CPU

## 七、分布式扩展

原有的项目结构

![image-20210316083421530](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210316083421530.png)

miaosha.jar与mysql在一台机器上，该机器的负载压力会很大

优化方案

![image-20210316083548073](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210316083548073.png)

将nginx，2个miaosha.jar以及mysql放在4台机器上

### 7.1、nginx

nginx的作用

![image-20210316083721654](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210316083721654.png)

项目结构再修改

![image-20210316083931076](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210316083931076.png)

前端的ajax请求访问miaoshaserver，nginx将请求反向代理到2个miaosha.jar中

前端的静态资源通过本地磁盘/NAS存储，当请求为miaoshaserver/resources时，就从磁盘读取

### 7.2、nginx部署

修改前端资源

新建gethost.js，定义变量g_host用来动态修改前端的ip地址和端口号，在本地调试的时候可以将IP改为本机IP，在虚拟机中运行时，将IP改为虚拟机IP。

```javascript
var g_host="192.168.13.129:8090";
```

在每个html中都引入gethost.js，并将ajax请求的URL中的固定IP和端口号用g_host的值代替

```html
<script src="./gethost.js" type="text/javascript"></script>

url:"http://"+g_host+"/item/list",
```

在/usr/local/openresty/nginx/conf下修改nginx的配置文件nginx.conf，添加upstream，名称为backend_server，内容为项目的ip:port，权重相等。静态资源文件放在/usr/local/openresty/nginx/html/resources下，配置location /resources/将静态资源的请求和其他请求分开。location /内配置nginx反向代理，将动态请求location为proxy_pass。配置完成后使用sbin/nginx -s reload重启nginx，使配置文件生效。

```pr
upstream backend_server{
        server 192.168.13.129:8090 weight=1;
        server 192.168.13.129:8091 weight=1;
        keepalive 30;
    }
    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location /resources/ {
            alias  /usr/local/openresty/nginx/html/resources/;
            index  index.html index.htm;
        }

        location / {
            proxy_pass http://backend_server;
            proxy_set_header Host $http_host:$proxy_port;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
		location = /50x.html {
            root   html;
        }


```

在application.properties中添加配置开启Tomcat  access log验证

```properties
server.tomcat.accesslog.enabled=true

server.tomcat.accesslog.directory=/home/sun/tomcat

server.tomcat.accesslog.pattern=%h %l %u %t "%r" %s %b %D

```

在浏览器中输入http://192.168.13.129/item/get?id=9

返回结果

![image-20210317155245733](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210317155245733.png)

2次请求后，2个Tomcat分别打印日志

home/sun/test/tomcat ![image-20210317155342881](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210317155342881.png)

home/sun/tomcat

![image-20210317155416578](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210317155416578.png)



### 7.3、nginx高性能原因

#### 7.3.1、epoll多路复用

https://www.cnblogs.com/ZenoLiang/p/11065505.html

https://blog.csdn.net/armlinuxww/article/details/92803381

#### 7.3.2、master worker进程模型

https://blog.csdn.net/Kim_Weir/article/details/80036462

#### 7.3.3、协程机制（存疑）



### 7.4、基于token的分布式会话

在虚拟机中安装redis，修改/usr/local/bin/hconfig下的redis.conf

将bind 的ip改为虚拟机的ip192.168.13.129

在application.properties中添加配置，使得项目连接redis服务器

```properties
spring.redis.host=192.168.13.129
```

在pom.xml中添加依赖

```xml
<dependency>
      <groupId>org.springframework.session</groupId>
      <artifactId>spring-session-data-redis</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
```



在本地代码中，使用token代替IS_LOGIN等标识符，通过redisTemplate实现token令牌与用户信息的绑定与存取

UserController

```java
//将登录凭证加到用户登录成功的session内

        //修改成若用户登录成功，则将用户信息和登录凭证一起放入redis中

        //生成登录凭证token，UUID
        String uuidToken = UUID.randomUUID().toString();
        uuidToken = uuidToken.replace("-","");
        //建立token和用户登录态的联系
        redisTemplate.opsForValue().set(uuidToken,userModel);
        redisTemplate.expire(uuidToken,1, TimeUnit.HOURS);
//        this.request.getSession().setAttribute("IS_LOGIN",true);
//        this.request.getSession().setAttribute("LOGIN_USER",userModel);
        return CommonRetrunType.create(uuidToken);
```

OrderController

```java
//Boolean isLogin = (Boolean) httpServletRequest.getSession().getAttribute("IS_LOGIN");
        String token = httpServletRequest.getParameterMap().get("token")[0];
        if (StringUtils.isEmpty(token)){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        UserModel userModel = (UserModel)redisTemplate.opsForValue().get(token);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
//获取用户登录信息
//UserModel userModel = (UserModel) httpServletRequest.getSession().getAttribute("LOGIN_USER");
```

前端页面

在login.html中，使用window.localStorage["token"]接收后端传来的token令牌

```html
$.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://"+g_host+"/user/login",
                data:{
                    "telephone":$("#telephone").val(),
                    "password":password,
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("登录成功");
						var token = data.data;
						window.localStorage["token"] = token;
                        window.location.href = "listitem.html";
                    }else {
                        alert("登录失败，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("登录失败，原因为"+data.responseText);
                }
            })
```

在getitem.html中，将token获取并发送给后端，如果token为空，则说明用户未登录，跳转到登录页面

```html
$("#createorder").on("click", function () {
			var token = window.localStorage["token"];
			if(token == null){
				alert("没有登录，不能下单");
				window.location.href="login.html";
				return false;
			}
            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://"+g_host+"/order/createorder?token="+token,
                data:{
                    "itemId":g_itemVO.id,
                    "amount":1,
                    "promoId":g_itemVO.promoId
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        alert("下单成功！");
                        //刷新界面
                        window.location.reload();
                    }else {
                        alert("下单失败，原因为"+data.data.errMsg );
                        if (data.data.errCode == 20003){
                            window.location.href = "login.html";
                        }

                    }
                },
                error:function (data) {
                    alert("下单失败，原因为"+data.responseText);
                }
            })
        });
```

将项目重新打包后上传到虚拟机中。

通过./redis-cli -h 192.168.13.129命令打开redis，keys  *获得登录的令牌信息

![image-20210316221647805](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210316221647805.png)

## 八、多级缓存

![image-20210317082456882](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210317082456882.png)

### 8.1、本地缓存与redis缓存

在ItemServiceImpl中，需要对mysql数据库进行3次查找，效率较低。

```java
 public ItemModel getItemById(Integer id) {
        ItemDO itemDO=itemDOMapper.selectByPrimaryKey(id);
        if(itemDO==null){
            return null;
        }
        //操作获得库存的数量
        ItemStockDO itemStockDO=itemStockDOMapper.selectByItemId(itemDO.getId());

        //将dataobject->model
        ItemModel itemModel=convertModelFromDataObject(itemDO,itemStockDO);

        //获取活动商品信息
        PromoModel promoModel=promoService.getPromoByItemId(itemModel.getId());
        if(promoModel!=null&&promoModel.getStatus().intValue()!=3){
             itemModel.setPromoModel(promoModel);
        }
        return itemModel;
    }
```

在ItemController中设置先从本地缓存中查找，如果本地缓存中没有，则去redis缓存中查找，如果redis缓存中也没有，再去mysql中查找，之后将查找结果存入本地缓存和redis缓存中

```java
 public CommonRetrunType getItem(@RequestParam(name = "id") Integer id){
        ItemModel itemModel = null;

        //先从本地缓存中查找
        itemModel = (ItemModel) cacheService.getCommonCache("item_"+id);
        //若本地缓存中不存在，去redis中查找
        if (itemModel == null){
            //从redis中查找对应的itemModel
            itemModel = (ItemModel) redisTemplate.opsForValue().get("item_"+id);
            if (itemModel == null){
                //redis中不存在再去mysql中找
                itemModel = itemService.getItemById(id);
                //将数据放到redis中
                redisTemplate.opsForValue().set("item_"+id,itemModel);
                redisTemplate.expire("item_"+id,10, TimeUnit.MINUTES);
            }
            //将数据放入本地缓存中
            cacheService.setCommonCache("item_"+id,itemModel);
        }


        ItemVO itemVO = this.convertItemVOFromModel(itemModel);
        return CommonRetrunType.create(itemVO);
    }
```

本地缓存需要使用Google的guava依赖

```xml
    <dependency>
      <groupId>com.google.guava</groupId>
      <artifactId>guava</artifactId>
      <version>18.0</version>
    </dependency>
```



在service包中定义CacheService接口用来封装本地缓存

```java
//封装本地缓存操作类
public interface CacheService {

    //存方法
    void setCommonCache(String key, Object value);

    //取方法
    Object getCommonCache(String key);
}

```

CacheServiceImpl实现类通过guava cache的CacheBuilder设置本地缓存的参数

```java
@Service
public class CacheServiceImpl implements CacheService {

    private Cache<String,Object> commonCache = null;

    @PostConstruct
    public void init(){
        commonCache = CacheBuilder.newBuilder()
                //设置缓存容器的初始容量为10
                .initialCapacity(10)
                //设置缓存中最多放100个key，超过后会使用LRU策略移除缓存项
                .maximumSize(100)
                //设置写缓存60秒后过期
                .expireAfterWrite(60, TimeUnit.SECONDS)
                .build();
    }
    @Override
    public void setCommonCache(String key, Object value) {
        commonCache.put(key,value);
    }

    @Override
    public Object getCommonCache(String key) {
        //如果存在就返回value，否则返回null
        return commonCache.getIfPresent(key);
    }
}
```

在itemModel对象中包含promoModel属性，promoModel又有JodaDateTime类型的秒杀活动开始时间和结束时间两个属性，需要序列化

新建serializer包，定义JodaDateTimeDeserializer和JodaDateTimeJsonSerializer两个类

```java
public class JodaDateTimeJsonSerializer extends JsonSerializer<DateTime> {
    @Override
    public void serialize(DateTime value, JsonGenerator gen, SerializerProvider serializers) throws IOException {
        gen.writeString(value.toString("yyyy-MM-dd HH:mm:ss"));
    }
}
```

```java
public class JodaDateTimeDeserializer extends JsonDeserializer<DateTime> {
    @Override
    public DateTime deserialize(JsonParser p, DeserializationContext ctxt) throws IOException, JsonProcessingException {
        String dateString = p.readValueAs(String.class);
        DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern("yyyy-MM-dd HH:mm:ss");
        return DateTime.parse(dateString,dateTimeFormatter);
    }
}
```

自定义RedisTemplate使得我们的JodaDateTime序列化与反序列化成功

```java
@Component
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 3600)
public class RedisConfig {
    @Bean
    public RedisTemplate redisTemplate(RedisConnectionFactory redisConnectionFactory){
        RedisTemplate redisTemplate = new RedisTemplate();
        redisTemplate.setConnectionFactory(redisConnectionFactory);

        //解决key的序列化方式
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        redisTemplate.setKeySerializer(stringRedisSerializer);

        //解决value的序列化方式
        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);

        ObjectMapper objectMapper = new ObjectMapper();
        SimpleModule simpleModule = new SimpleModule();
        simpleModule.addSerializer(DateTime.class, new JodaDateTimeJsonSerializer());
        simpleModule.addDeserializer(DateTime.class, new JodaDateTimeDeserializer());
        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
        objectMapper.registerModule(simpleModule);
        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);

        return redisTemplate;
    }
}

```

### 8.2、nginx proxy cache

将项目打包上传到虚拟机后，修改conf/nginx.conf配置文件

```properties
#声明一个cache缓存节点的内容
    proxy_cache_path /usr/local/openresty/nginx/tmp_cache levels=1:2 keys_zone=tmp_cache:100m inactive=7d max_size=10g;
location / {
            proxy_pass http://backend_server;
            proxy_cache tmp_cache;
            proxy_cache_methods GET HEAD POST;
            proxy_cache_key $host$uri$is_args$args;
            proxy_cache_valid 200 206 304 302 7d;
            proxy_ignore_headers Cache-Control Set-Cookie;
            add_header Nginx-Cache "$upstream_cache_status";
            proxy_set_header Host $http_host:$proxy_port;
           # proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

```

**proxy_cache_key** 这个属性不可以只配置$uri，否则他会只匹配/item/get，无论id=9还是id=10，他都只会返回cache中存在的。

在/usr/local/openresty/nginx/tmp_cache目录下会生成缓存文件，通过cat命令查看对应的内容

```
[root@miaoshaserver 57]# cat e6b5b630ce304e0d583c5d056c14e572 
ⴛ`ÿÿÿÿÿÿÿÿa»R`/®¶t?Access-Control-Request-Headerŝ󿿜
> 
`п:
   E
KEY: 192.168.13.129/item/get?id=10
HTTP/1.1 200 
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Content-Type: application/json
Transfer-Encoding: chunked
Date: Thu, 18 Mar 2021 02:30:57 GMT

{"status":"success","data":{"id":10,"title":"iPhone99","price":20099,"stock":9998,"description":"手机99","sales":1,"imgUrl":"https://dss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=3118799085,3545635564&fm=26&gp=0.jpg","promoStatus":2,"promoPrice":1,"promoId":2,"startDate":"2021-03-10 04:00:00"}}
```

### 8.3、openResty实战

在/usr/local/openresty/lua目录下编写lua脚本，itemredis.lua

```lua
local args = ngx.req.get_uri_args()
local id = args["id"]
local redis = require "resty.redis"
local cache = redis:new()
local ok,err = cache:connect("192.168.13.129",6379)
local item_model = cache:get("item_"..id)
if item_model == ngx.null or item_model == nil then
        local resp = ngx.location.capture("/item/get?id="..id)
        item_model = resp.body
end

ngx.say(item_model)
```

在nginx.conf中修改

```properties
lua_shared_dict my_cache 128m;#加入shared dictionary的扩展，声明128m的共享字典的访问内存

location /luaitem/get{
            default_type "application/json";
            content_by_lua_file ../lua/itemredis.lua;
}
```

当在浏览器中输入http://192.168.13.129/luaitem/get?id=9，如果nginx proxy cache中没有，就会去redis中查找，还没有就去mysql中找，之后会将结果存入redis中

## 九、缓存库存

### 9.1、redis缓存存储商品详情

当OrderController收到客户端发起的下单请求时，OrderController先校验用户的登录信息，校验无误后调用createModel方法完成下单，在createModel中第一步就是要获取itemModel，此时，如果redis缓存中有对应itemId的商品信息，就可以直接返回，无需再去mysql中查找。

在ItemService接口中声明getItemByIdInCache

```java
//itemModel及promoModel缓存模型
ItemModel getItemByIdInCache(Integer id);
```

在ItemServiceImpl中实现，如果缓存中没有这个信息，就去mysql中查找，如果mysql中查找成功，就把结果放到redis缓存中

```java
 @Override
    public ItemModel getItemByIdInCache(Integer id) {
        ItemModel itemModel = (ItemModel) redisTemplate.opsForValue().get("item_validate_"+id);
        if (itemModel == null){
            itemModel = this.getItemById(id);
            redisTemplate.opsForValue().set("item_validate_"+id,itemModel);
            redisTemplate.expire("item_validate_"+id,10, TimeUnit.MINUTES);
        }
        return itemModel;
    }

```

### 9.2、redis缓存存储用户信息

在获取到itemModel后，第二步就是要获取UserModel，也可以这样优化

在UserService接口中声明getUserByIdInCache方法

```java
//通过缓存获取用户对象
    UserModel getUserByIdInCache(Integer id);
```

在UserServiceImpl中实现

```java
@Override
    public UserModel getUserByIdInCache(Integer id) {
        UserModel userModel = (UserModel) redisTemplate.opsForValue().get("user_validate_"+id);
        if (userModel == null){
            userModel = this.getUserById(id);
            redisTemplate.opsForValue().set("user_validate_"+id,userModel);
            redisTemplate.expire("user_validate_"+id,10, TimeUnit.MINUTES);
        }
        return userModel;
    }
```

在orderServiceImpl中的createOrder中调用这两个方法

```java
ItemModel itemModel = itemService.getItemByIdInCache(itemId);
if (itemModel == null){
    throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"商品信息不存在");
}
UserModel userModel = userService.getUserByIdInCache(userId);
if (userModel == null){
    throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"用户信息不存在");
}
```

### 9.3、redis缓存库存信息

在下单请求中，校验了商品信息，用户信息以及活动信息后，就要减少库存了

```java
//2、落单减库存
        boolean result = itemService.decreaseStock(itemId,amount);
        if (!result){
            throw new BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }
```

在itemStockDOMapper.xml中，decreaseStock是update语句，需要给item_id添加索引，在mysql中运行时，才能加锁

```xml
<update id="decreaseStock" >
    update item_stock
    set stock = stock - #{amount}
    where item_id = #{itemId} and stock > #{amount}
  </update>
```

加上唯一索引

```sql
alter table item_stock add unique index
item_id_index(item_id)
```

即使这样，性能仍然得不到提升，于是我们想把扣减库存的操作在redis中实现，将库存信息放到redis内。

![image-20210319160327105](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210319160327105.png)

#### 9.3.1、活动发布同步库存进缓存

在promoService中声明publishPromo

```java
//活动发布
    void publishPromo(Integer promoId);
```

在promoServiceImpl中实现

```java
@Override
    public void publishPromo(Integer promoId) {
        //通过活动id获取活动
        PromoDO promoDO = promoDOMapper.selectByPrimaryKey(promoId);
        if (promoDO.getItemId() == null || promoDO.getItemId().intValue() == 0){
            return;
        }
        ItemModel itemModel = itemService.getItemById(promoDO.getItemId());
        //将库存同步到redis内
        redisTemplate.opsForValue().set("promo_item_stock_"+itemModel.getId(),itemModel.getStock());

    }
```

在itemController中声明一个接口，来调用publishpromo方法

```java
@RequestMapping(value = "/publishpromo",method = {RequestMethod.GET})
    @ResponseBody
    public CommonRetrunType publishPromo(@RequestParam(name = "id") Integer id){
        promoService.publishPromo(id);
        return CommonRetrunType.create(null);
    }
```

#### 9.3.2、下单交易扣减缓存中的库存

```java
@Override
    @Transactional
    public boolean decreaseStock(Integer itemId, Integer amount) throws BusinessException {
        long affectedRow = redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue()*(-1));
        if (affectedRow >= 0){
            //更新库存成功
            redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue());
            return true;
        }else {
            //更新库存失败
            return false;
        }
    }

```

**问题：只更新了redis缓存中的值，数据库中的值还没有更新**

我们需要使用消息队列来异步更新数据库中的值

### 9.4、rocketmq

1、rocketmq的安装

在/home/sun目录下新建文件夹rocketmq，解压rocketmq-all-4.3.2-bin-release.zip，将解压后的文件夹名称改为rocketmq并进入该文件夹。

2、修改mqbroker相关配置

在/home/sun/rocketmq/rocketmq/bin下，修改mqborker.xml

```xml
<-XX:NewSize>128M</-XX:NewSize>
<-XX:MaxNewSize>128M</-XX:MaxNewSize>
<-XX:PermSize>64M</-XX:PermSize>
<-XX:MaxPermSize>64M</-XX:MaxPermSize>
```

修改runbroker.sh

```properties
JAVA_OPT="${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn512m"
```

修改tools.sh

```properties
JAVA_OPT="${JAVA_OPT} -server -Xms1g -Xmx1g -Xmn256m -XX:PermSize=128m -XX:MaxPermSize=128m"
JAVA_OPT="${JAVA_OPT} -Djava.ext.dirs=${BASE_DIR}/lib:${JAVA_HOME}/jre/lib/ext:/usr/java/jdk1.8.0_65/jre/lib/ext"
```

修改conf/broker.conf

```properties
brokerIP1 = 192.168.13.129
namesrvAddr=192.168.13.129:9876
```

3、开启nameserver

```
nohup sh bin/mqnamesrv &
tail -f ~/logs/rocketmqlogs/namesrv.log
```

4、启动mqbroker

```
nohup sh bin/mqbroker -n 192.168.13.129:9876 -c conf/broker.conf autoCreateTopicEnable=true &
tail -f ~/logs/rocketmqlogs/broker.log 
```

### 9.5、缓存库存接入异步化

在pom.xml中添加依赖

```xml
<dependency>
      <groupId>org.apache.rocketmq</groupId>
      <artifactId>rocketmq-client</artifactId>
      <version>4.3.0</version>
    </dependency>
```

在application.properties中添加rocketmq的相关配置

```properties
mq.nameserver.addr=192.168.13.129:9876
mq.topicname=stock
```

在项目中新建mq包，新建mqProducer和mqConsumer类

```java
@Component
public class MqProducer {

    private DefaultMQProducer producer;

    @Value("${mq.nameserver.addr}")
    private String nameAddr;

    @Value("${mq.topicname}")
    private String topicName;

    @PostConstruct
    public void init() throws MQClientException {
        //mq producer初始化
        producer = new DefaultMQProducer("producer_group");
        producer.setNamesrvAddr(nameAddr);
        producer.setSendMsgTimeout(7000);//不加会报错，超时
        producer.start();
    }

    //同步库存扣减消息
    public boolean asyncReduceStock(Integer itemId, Integer amount) {
        Map<String,Object> bodyMap = new HashMap<>();
        bodyMap.put("itemId",itemId);
        bodyMap.put("amount",amount);
        Message message = new Message(topicName, "increase",
                JSON.toJSON(bodyMap).toString().getBytes(Charset.forName("UTF-8")));
        try {
            producer.send(message);
        } catch (MQClientException e) {
            e.printStackTrace();
            return false;
        } catch (RemotingException e) {
            e.printStackTrace();
            return false;
        } catch (MQBrokerException e) {
            e.printStackTrace();
            return false;
        } catch (InterruptedException e) {
            e.printStackTrace();
            return false;
        }
        return true;
    }
}

```



```java
@Component
public class MqConsumer {

    private DefaultMQPushConsumer consumer;

    @Value("${mq.nameserver.addr}")
    private String nameAddr;

    @Value("${mq.topicname}")
    private String topicName;

    @Autowired
    private ItemStockDOMapper itemStockDOMapper;

    @PostConstruct
    public void init() throws MQClientException {
        consumer = new DefaultMQPushConsumer("stock_consumer_group");
        consumer.setNamesrvAddr(nameAddr);
        consumer.subscribe(topicName,"*");//consumer订阅的哪一个topic(stock)的什么类型(*,全部)的消息
		//注册消息监听器，当收到消息后要做哪些处理
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> list, ConsumeConcurrentlyContext consumeConcurrentlyContext) {
                //实现库存真正到数据库扣减
                Message msg = list.get(0);
                String jsonString = new String(msg.getBody());
                Map<String,Object> map = JSON.parseObject(jsonString,Map.class);
                Integer itemId = (Integer) map.get("itemId");
                Integer amount = (Integer) map.get("amount");
                itemStockDOMapper.decreaseStock(itemId,amount);
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        consumer.start();
    }
}

```



ItemServiceImpl中的decreaseStock方法使用消息队列完成异步更新数据库信息的功能

```java
@Override
    @Transactional
    public boolean decreaseStock(Integer itemId, Integer amount) throws BusinessException {
        //int affectedRow = itemStockDOMapper.decreaseStock(itemId,amount);
        long affectedRow = redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue()*(-1));
        if (affectedRow >= 0){
            //更新库存成功
            boolean mqResult = mqProducer.asyncReduceStock(itemId,amount);
            if (!mqResult){
                //消息队列出现异常
                redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue());
                return false;
            }
            return true;
        }else {
            //更新库存失败
            redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue());
            return false;
        }
    }
```

## 十、事务型消息



### 10.1、rocketmq事务型消息

- Half Message，半消息

暂时不能被 `Consumer`消费的消息。`Producer`已经把消息发送到 `Broker`端，但是此消息的状态被标记为不能投递，处于这种状态下的消息称为半消息。事实上，该状态下的消息会被放在一个叫做 `RMQ_SYS_TRANS_HALF_TOPIC`的主题下。

当 `Producer`端对它二次确认后，也就是 `Commit`之后，`Consumer`端才可以消费到；那么如果是`Rollback`，该消息则会被删除，永远不会被消费到。

- 事务状态回查

我们想，可能会因为网络原因、应用问题等，导致`Producer`端一直没有对这个半消息进行确认，那么这时候 `Broker`服务器会定时扫描这些半消息，主动找`Producer`端查询该消息的状态。

`RocketMQ`事务消息的实现原理就是基于两阶段提交和事务状态回查，来决定消息最终是提交还是回滚的。

在myproducer中声明TransactionMQProducer类变量

```java
private TransactionMQProducer transactionMQProducer;
```

通过事务型消息扣减库存

```java 
//事务型同步库存扣减消息
    public boolean transactionAsyncReduceStock(Integer userId, Integer itemId, Integer promoId, Integer amount, String stockLogId){
        Map<String,Object> bodyMap = new HashMap<>();
        bodyMap.put("itemId",itemId);
        bodyMap.put("amount",amount);
        bodyMap.put("stockLogId",stockLogId);

        Map<String,Object> argsMap = new HashMap<>();
        argsMap.put("userId",userId);
        argsMap.put("itemId",itemId);
        argsMap.put("promoId",promoId);
        argsMap.put("amount",amount);
        argsMap.put("stockLogId",stockLogId);

        Message message = new Message(topicName, "increase",
                JSON.toJSON(bodyMap).toString().getBytes(Charset.forName("UTF-8")));
        TransactionSendResult sendResult = null;
        try {
            sendResult = transactionMQProducer.sendMessageInTransaction(message,argsMap);
        } catch (MQClientException e) {
            e.printStackTrace();
        }
        if (sendResult.getLocalTransactionState() == LocalTransactionState.ROLLBACK_MESSAGE){
            return false;
        }else if (sendResult.getLocalTransactionState() == LocalTransactionState.COMMIT_MESSAGE){
            return true;
        }else {
            return false;
        }

    }
```

在init()初始化时，新建一个listener对象并实现executeLocalTransaction方法和checkLocalTransaction方法

```java 
transactionMQProducer = new TransactionMQProducer("transaction_producer_group");
        transactionMQProducer.setNamesrvAddr(nameAddr);
        transactionMQProducer.setSendMsgTimeout(7000);
        transactionMQProducer.start();

        transactionMQProducer.setTransactionListener(new TransactionListener() {
            @Override
            public LocalTransactionState executeLocalTransaction(Message message, Object o) {
                //真正要做的事情 创建订单
                Integer userId = (Integer) ((Map)o).get("userId");
                Integer itemId = (Integer) ((Map)o).get("itemId");
                Integer promoId = (Integer) ((Map)o).get("promoId");
                Integer amount = (Integer) ((Map)o).get("amount");
                String stockLogId = (String)((Map)o).get("stockLogId");
                try {
                    orderService.createModel(userId,itemId,promoId,amount,stockLogId);
                } catch (BusinessException e) {
                    //出现异常，事务回滚
                    e.printStackTrace();
                    //设置stockLog为回滚状态
                    StockLogDO stockLogDO = stockLogDOMapper.selectByPrimaryKey(stockLogId);
                    stockLogDO.setStatus(3);
                    stockLogDOMapper.updateByPrimaryKeySelective(stockLogDO);
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
                //正常执行，提交事务
                return LocalTransactionState.COMMIT_MESSAGE;
            }

            @Override
            public LocalTransactionState checkLocalTransaction(MessageExt msg) {
                //根据库存扣减是否成功来判断返回commit还是rollback
                String jsonString = new String(msg.getBody());
                Map<String,Object> map = JSON.parseObject(jsonString,Map.class);
                Integer itemId = (Integer) map.get("itemId");
                Integer amount = (Integer) map.get("amount");
                String stockLogId = (String)map.get("stockLogId");
                StockLogDO stockLogDO = stockLogDOMapper.selectByPrimaryKey(stockLogId);
                if (stockLogDO == null){
                    return LocalTransactionState.UNKNOW;
                }
                if (stockLogDO.getStatus().intValue() == 2){
                    return LocalTransactionState.COMMIT_MESSAGE;
                }else if (stockLogDO.getStatus().intValue() == 1){
                    return LocalTransactionState.UNKNOW;
                }else {
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
            }
        });
```



![img](https://upload-images.jianshu.io/upload_images/9033085-dd384efdd1a1a232?imageMogr2/auto-orient/strip|imageView2/2/w/1080/format/webp)



当transactionAsyncReduceStock中sendMessageInTransaction时即为图中的1阶段

-返回为COMMIT_MESSAGE时，执行executeLocalTransaction方法内的代码，即步骤2、3和4，完成本地事务的功能。

-如果此时发送预备消息出了问题，broker端不会接收任何消息，不会影响后续的操作

若executeLocalTransaction方法正常执行，会返回LocalTransactionState.COMMIT_MESSAGE，即步骤5；若出现异常返回LocalTransactionState.ROLLBACK_MESSAGE，broker会删除那个预备消息，订阅者无法消费；若executeLocalTransaction方法正常执行，但是向broker发送确认消息出现问题，或返回LocalTransactionState.UNKNOW时，broker会进行回查，执行checkLocalTransaction方法中的内容，如果**发现本地业务没有执行成功就rollBack**，如果**执行成功就发送commit消息。**

步骤5正常完成后，broker会把该预备信息改为确认信息，consumer端的listener会监听到消息并读取，即为步骤6,7.



问题：回查如何判断事务是否成功？

解决办法：在数据库中新建stock_log表

![image-20210320173915219](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210320173915219.png)

每一笔交易都有一个流水，对于数据库中的stock_log_id，以及状态status，1代表初始化，2代表成功，3代表回滚

因此，在回查过程中，只需要根据stockDo是否存在以及stockDo的status是多少判断事务是否成功。

### 10.2、商品售罄处理方案

当订单量很大时，秒杀商品数量很少，大部分的流水都是无意义的，所以在初始化流水之前，我们需要判断商品是否售罄。

在orderController中

```java
//初始化流水之前，先判断商品是否售罄，若对应的售罄key存在，则直接抛出库存不足异常
        if (redisTemplate.hasKey("promo_item_stock_invaild_"+itemId)){
            throw new BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }
        //初始化流水
        String stockLogId = itemService.initStockLog(itemId,amount);
```

在ItemServiceImpl中

```java
    //初始化对应的库存流水
    @Override
    @Transactional
    public String initStockLog(Integer itemId, Integer amount) {
        StockLogDO stockLogDO = new StockLogDO();
        stockLogDO.setItemId(itemId);
        stockLogDO.setAmount(amount);
        stockLogDO.setStockLogId(UUID.randomUUID().toString().replace("-",""));
        stockLogDO.setStatus(1);
        stockLogDOMapper.insertSelective(stockLogDO);

        return stockLogDO.getStockLogId();
    }

    @Override
    @Transactional
    public boolean decreaseStock(Integer itemId, Integer amount) throws BusinessException {
        //int affectedRow = itemStockDOMapper.decreaseStock(itemId,amount);
        long affectedRow = redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue()*(-1));
        if (affectedRow > 0){
            //更新库存成功
            return true;
        }else if (affectedRow == 0){
            //更新库存成功，添加商品售罄标识
            redisTemplate.opsForValue().set("promo_item_stock_invaild_"+itemId,"true");
            return true;

        }else {
            //更新库存失败
            //redisTemplate.opsForValue().increment("promo_item_stock_"+itemId,amount.intValue());
            increaseStock(itemId,amount);
            return false;
        }
    }
```

### 10.3、下单操作的流程

![image-20210320181724724](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210320181724724.png)

## 十一、流量削峰

### 11.1、秒杀令牌

在PromoService中声明generateSecondKillToken接口

```java
//生成秒杀用的令牌
    String generateSecondKillToken(Integer promoId, Integer itemId, Integer userId);
```

在PromoServiceImpl中实现

```java
 @Override
    public String generateSecondKillToken(Integer promoId, Integer itemId, Integer userId) {
        PromoDO promoDO = promoDOMapper.selectByPrimaryKey(promoId);
        PromoModel promoModel = this.convertPromoModelFromPromoDO(promoDO);
        if (promoModel == null){
            return null;
        }
        //判断当前时间秒杀活动是正在进行还是即将开始
        if (promoModel.getStartDate().isAfterNow()){//秒杀活动还未开始
            promoModel.setStatus(1);
        }else if (promoModel.getEndDate().isBeforeNow()){//秒杀活动已结束
            promoModel.setStatus(3);
        }else {//秒杀活动正在进行
            promoModel.setStatus(2);
        }

        //只有status为2时，秒杀活动才开始，才允许获得令牌
        if (promoModel.getStatus().intValue() != 2){
            return null;
        }

        //判断item信息是否存在
        ItemModel itemModel = itemService.getItemByIdInCache(itemId);
        if (itemModel == null){
            return null;
        }

        //判断user信息是否存在
        UserModel userModel = userService.getUserByIdInCache(userId);
        if (userModel == null){
            return null;
        }

        //生成token并存入redis内，设置5分钟有效期
        String token = UUID.randomUUID().toString().replace("-","");
        redisTemplate.opsForValue().set("promo_token_"+promoId+"_userId_"+userId+"_itemId_"+itemId,token);
        redisTemplate.expire("promo_token_"+promoId+"_userId_"+userId+"_itemId_"+itemId,5, TimeUnit.MINUTES);
        return token;
    }
```

先判断秒杀活动是否存在，若秒杀活动存在且处于开始状态，才准备生成令牌，之后校验商品信息和用户信息，都无误后使用UUID来生成令牌并在redis中存储

在OrderController中声明generatetoken接口，对校验信息无误的用户生成秒杀令牌

```java
//生成秒杀令牌
    @RequestMapping(value = "/generatetoken",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType generateYoken(@RequestParam(name = "itemId")Integer itemId,
                                        @RequestParam(name = "promoId")Integer promoId) throws BusinessException {
        //根据token获取用户信息
        String token = httpServletRequest.getParameterMap().get("token")[0];
        if (StringUtils.isEmpty(token)){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        //获取用户登录信息
        UserModel userModel = (UserModel)redisTemplate.opsForValue().get(token);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        //获取秒杀令牌
        String promoToken = promoService.generateSecondKillToken(promoId, itemId, userModel.getId());
        if(promoToken == null){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"令牌生成失败");
        }

        return CommonRetrunType.create(promoToken);

    }

```

在createorder中，判断商品是否售罄之前，校验秒杀令牌

```java
//封装下单请求
    @RequestMapping(value = "/createorder",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonRetrunType createOrder(@RequestParam(name = "itemId")Integer itemId,
                                        @RequestParam(name = "amount")Integer amount,
                                        @RequestParam(name = "promoId",required = false)Integer promoId,
                                        @RequestParam(name = "promoToken",required = false)String promoToken) throws BusinessException {

        String token = httpServletRequest.getParameterMap().get("token")[0];
        if (StringUtils.isEmpty(token)){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }
        //获取用户登录信息
        UserModel userModel = (UserModel)redisTemplate.opsForValue().get(token);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN);
        }

        //校验秒杀令牌
        if (promoId != null){
            String promoTokenInRedis = (String) redisTemplate.opsForValue().get("promo_token_"+promoId+"_userId_"+userModel.getId()+"_itemId_"+itemId);
            if (promoTokenInRedis == null){
                throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"秒杀令牌校验失败");
            }
            if (!StringUtils.equals(promoTokenInRedis,promoToken)){
                throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"秒杀令牌校验失败");
            }
        }

        //初始化流水之前，先判断商品是否售罄，若对应的售罄key存在，则直接抛出库存不足异常
        if (redisTemplate.hasKey("promo_item_stock_invaild_"+itemId)){
            throw new BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }
        //初始化流水
        String stockLogId = itemService.initStockLog(itemId,amount);


        boolean orderResult = mqProducer.transactionAsyncReduceStock(userModel.getId(),itemId,promoId,amount,stockLogId);
        if (!orderResult){
            throw new BusinessException(EmBusinessError.UNKNOWN_ERROR,"下单失败");
        }
        return CommonRetrunType.create(null);
    }
}
```

在前端页面，当用户点击下单，先访问generatetoken接口，获得秒杀令牌，之后再访问createorder接口，将秒杀令牌作为参数传入。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css"/>
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
	<script src="./gethost.js" type="text/javascript"></script>
    <title>Title</title>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">商品详情</h3>
    <div id="promoStartDateContainer" class="form-group">
        <label style="color: blue" id="promoStatus" class="control-label"></label>
        <div>
            <label style="color: red" class="control-label" id="promoStartDate"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品名</label>
        <div>
            <label class="control-label" id="title"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <label class="control-label" id="description"/>
        </div>
    </div>
    <div id="normalPriceContainer" class="form-group">
        <label class="control-label">价格</label>
        <div>
            <label class="control-label" id="price"/>
        </div>
    </div>
    <div id="promoPriceContainer" class="form-group">
        <label style="color: red" class="control-label">秒杀价格</label>
        <div>
            <label style="color: red" class="control-label" id="promoPrice"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">图片</label>
        <div>
            <img style="width: 200px;height: auto" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">库存</label>
        <div>
            <label class="control-label" id="stock"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">销量</label>
        <div>
            <label class="control-label" id="sales"/>
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="createorder" type="submit">
            下单
        </button>
    </div>

</div>
</body>

<script>
    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null),paramValue
    }
    var g_itemVO = {};
    jQuery(document).ready(function () {
        $("#createorder").on("click", function () {
			var token = window.localStorage["token"];
			if(token == null){
				alert("没有登录，不能下单");
				window.location.href="login.html";
				return false;
			}

            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://"+g_host+"/order/generatetoken?token="+token,
                data:{
                    "itemId":g_itemVO.id,
                    "promoId":g_itemVO.promoId
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        var promoToken = data.data;
                        $.ajax({
                            type:"POST",
                            contentType:"application/x-www-form-urlencoded",
                            url:"http://"+g_host+"/order/createorder?token="+token,
                            data:{
                                "itemId":g_itemVO.id,
                                "amount":1,
                                "promoId":g_itemVO.promoId,
                                "promoToken":promoToken
                            },
                            xhrFields:{withCredentials:true},
                            success:function(data){
                                if (data.status == "success"){
                                    alert("下单成功！");
                                    //刷新界面
                                    window.location.reload();
                                }else {
                                    alert("下单失败，原因为"+data.data.errMsg );
                                    if (data.data.errCode == 20003){
                                        window.location.href = "login.html";
                                    }

                                }
                            },
                            error:function (data) {
                                alert("下单失败，原因为"+data.responseText);
                            }
                        })
                    }else {
                        alert("获取令牌失败，原因为"+data.data.errMsg );
                        if (data.data.errCode == 20003){
                            window.location.href = "login.html";
                        }
                    }
                },
                error:function (data) {
                    alert("获取令牌失败，原因为"+data.responseText);
                }
            })


        });
        //获取商品详情
            $.ajax({
                type:"GET",
                url:"http://"+g_host+"/item/get",
                data:{
                    "id":getParam("id"),

                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        g_itemVO = data.data;
                        reloadDom();
                        //倒计时，每隔一秒刷新
                        setInterval(reloadDom,1000);
                    }else {
                        alert("获取信息失败了，原因为"+data.data.errMsg );
                    }
                },
                error:function (data) {
                    alert("获取信息失败，原因为"+data.responseText);
                }
            })

        return false;
    });
    function reloadDom() {
        $("#title").text(g_itemVO.title);
        $("#description").text(g_itemVO.description);
        $("#stock").text(g_itemVO.stock);
        $("#price").text(g_itemVO.price);
        $("#imgUrl").attr("src",g_itemVO.imgUrl);
        $("#sales").text(g_itemVO.sales);
        if (g_itemVO.promoStatus == 1){
            //秒杀活动还未开始
            var startTime = g_itemVO.startDate.replace(new RegExp("-","gm"),"/");

            startTime = (new Date(startTime)).getTime();

            var nowTime = Date.parse(new Date());

            var delta = (startTime - nowTime) / 1000;


            if(delta<=0){
                //活动开始
                g_itemVO.promoStatus=2;
                reloadDom();
            }

            $("#promoStartDate").text("秒杀活动将于"+g_itemVO.startDate+"开始 倒计时："+delta+"秒");
            $("#promoPrice").text(g_itemVO.promoPrice);
            //活动没开始的话不允许下单
            $("#createorder").attr("disabled",true);
        }else if (g_itemVO.promoStatus == 2){
            //秒杀活动正在进行中
            $("#promoStartDate").text("秒杀正在进行中");
            $("#promoPrice").text(g_itemVO.promoPrice);
            //活动开始后可以下单
            $("#createorder").attr("disabled",false);
            $("#normalPriceContainer").hide();
        }
    }
</script>
</html>
```

### 11.2、秒杀大闸

秒杀大闸用来限制秒杀令牌的发放数量

在promoServiceImpl的publishPromo方法里限定好秒杀大闸的数量，在秒杀活动发布的时候，这个数量就被存入redis里

```java
//将秒杀大闸的数字限制到redis内
        //大闸的数字为当前秒杀商品库存的5倍
        redisTemplate.opsForValue().set("promo_door_count_"+promoId,itemModel.getStock().intValue() * 5);
```

在generateSecondKillToken中，生成秒杀令牌前，先判断秒杀大闸的数量是否大于0，如果不是，则不发放令牌

```java
@Override
    public String generateSecondKillToken(Integer promoId, Integer itemId, Integer userId) {
        PromoDO promoDO = promoDOMapper.selectByPrimaryKey(promoId);
        PromoModel promoModel = this.convertPromoModelFromPromoDO(promoDO);
        if (promoModel == null){
            return null;
        }
        //判断当前时间秒杀活动是正在进行还是即将开始
        if (promoModel.getStartDate().isAfterNow()){//秒杀活动还未开始
            promoModel.setStatus(1);
        }else if (promoModel.getEndDate().isBeforeNow()){//秒杀活动已结束
            promoModel.setStatus(3);
        }else {//秒杀活动正在进行
            promoModel.setStatus(2);
        }

        //只有status为2时，秒杀活动才开始，才允许获得令牌
        if (promoModel.getStatus().intValue() != 2){
            return null;
        }

        //判断item信息是否存在
        ItemModel itemModel = itemService.getItemByIdInCache(itemId);
        if (itemModel == null){
            return null;
        }

        //判断user信息是否存在
        UserModel userModel = userService.getUserByIdInCache(userId);
        if (userModel == null){
            return null;
        }

        //获取秒杀大闸的count数量
        long result = redisTemplate.opsForValue().increment("promo_door_count_"+promoId, -1);
        if (result < 0){
            return null;
        }

        //生成token并存入redis内，设置5分钟有效期
        String token = UUID.randomUUID().toString().replace("-","");
        redisTemplate.opsForValue().set("promo_token_"+promoId+"_userId_"+userId+"_itemId_"+itemId,token);
        redisTemplate.expire("promo_token_"+promoId+"_userId_"+userId+"_itemId_"+itemId,5, TimeUnit.MINUTES);
        return token;
    }
```

### 11.3、队伍泄洪

在OrderController中定义ExecutorService变量，并且初始化一个大小为20的线程池

```java
 private ExecutorService executorService;

    @PostConstruct
    public void init(){
        executorService = Executors.newFixedThreadPool(20);
    }
```

@PostConstruct该注解被用来修饰一个非静态的void（）方法。被@PostConstruct修饰的方法会在服务器加载Servlet的时候运行，并且只会被服务器执行一次。PostConstruct在构造函数之后执行，init（）方法之前执行。

将初始化流水以及事务型消息放到线程的call方法中，同时只能有20个用户进行减库存操作，其他的都需要排队，达到泄洪的目的。

```java
Future<Object> future = executorService.submit(new Callable<Object>() {
            @Override
            public Object call() throws Exception {
                //初始化流水
                String stockLogId = itemService.initStockLog(itemId,amount);


                boolean orderResult = mqProducer.transactionAsyncReduceStock(userModel.getId(),itemId,promoId,amount,stockLogId);
                if (!orderResult){
                    throw new BusinessException(EmBusinessError.UNKNOWN_ERROR,"下单失败");
                }
                return null;
            }
        });

        try {
            future.get();
        } catch (InterruptedException e) {
            throw new BusinessException(EmBusinessError.UNKNOWN_ERROR);
        } catch (ExecutionException e) {
            throw new BusinessException(EmBusinessError.UNKNOWN_ERROR);
        }
```

## 十二、防刷限流

### 12.1、验证码

新建Util包，编写CodeUtil工具类生成验证码

```java

public class CodeUtil {
    private static int width = 90;// 定义图片的width
    private static int height = 20;// 定义图片的height
    private static int codeCount = 4;// 定义图片上显示验证码的个数
    private static int xx = 15;
    private static int fontHeight = 18;
    private static  int codeY = 16;
    private static char[] codeSequence = { 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R',
            'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9' };

    /**
     * 生成一个map集合
     * code为生成的验证码
     * codePic为生成的验证码BufferedImage对象
     * @return
     */
    public static Map<String,Object> generateCodeAndPic() {
        // 定义图像buffer
        BufferedImage buffImg = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        // Graphics2D gd = buffImg.createGraphics();
        // Graphics2D gd = (Graphics2D) buffImg.getGraphics();
        Graphics gd = buffImg.getGraphics();
        // 创建一个随机数生成器类
        Random random = new Random();
        // 将图像填充为白色
        gd.setColor(Color.WHITE);
        gd.fillRect(0, 0, width, height);

        // 创建字体，字体的大小应该根据图片的高度来定。
        Font font = new Font("Fixedsys", Font.BOLD, fontHeight);
        // 设置字体。
        gd.setFont(font);

        // 画边框。
        gd.setColor(Color.BLACK);
        gd.drawRect(0, 0, width - 1, height - 1);

        // 随机产生40条干扰线，使图象中的认证码不易被其它程序探测到。
        gd.setColor(Color.BLACK);
        for (int i = 0; i < 30; i++) {
            int x = random.nextInt(width);
            int y = random.nextInt(height);
            int xl = random.nextInt(12);
            int yl = random.nextInt(12);
            gd.drawLine(x, y, x + xl, y + yl);
        }

        // randomCode用于保存随机产生的验证码，以便用户登录后进行验证。
        StringBuffer randomCode = new StringBuffer();
        int red = 0, green = 0, blue = 0;

        // 随机产生codeCount数字的验证码。
        for (int i = 0; i < codeCount; i++) {
            // 得到随机产生的验证码数字。
            String code = String.valueOf(codeSequence[random.nextInt(36)]);
            // 产生随机的颜色分量来构造颜色值，这样输出的每位数字的颜色值都将不同。
            red = random.nextInt(255);
            green = random.nextInt(255);
            blue = random.nextInt(255);

            // 用随机产生的颜色将验证码绘制到图像中。
            gd.setColor(new Color(red, green, blue));
            gd.drawString(code, (i + 1) * xx, codeY);

            // 将产生的四个随机数组合在一起。
            randomCode.append(code);
        }
        Map<String,Object> map  =new HashMap<String,Object>();
        //存放验证码
        map.put("code", randomCode);
        //存放生成的验证码BufferedImage对象
        map.put("codePic", buffImg);
        return map;
    }

```

在OrderController中新建generateverifycode接口

```java
//生成验证码
    @RequestMapping(value = "/generateverifycode",method = {RequestMethod.GET,RequestMethod.POST})
    @ResponseBody
    public void generateVerifyCode(HttpServletResponse response) throws BusinessException, IOException {
        String token = httpServletRequest.getParameterMap().get("token")[0];
        if (StringUtils.isEmpty(token)){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN,"用户还未登录，不能生成验证码");
        }
        //获取用户登录信息
        UserModel userModel = (UserModel)redisTemplate.opsForValue().get(token);
        if (userModel == null){
            throw new BusinessException(EmBusinessError.USER_NOT_LOGIN,"用户还未登录，不能生成验证码");
        }
        Map<String,Object> map = CodeUtil.generateCodeAndPic();

        //将验证码与用户信息绑定到redis中
        redisTemplate.opsForValue().set("verify_code_"+userModel.getId(),map.get("code"));
        redisTemplate.expire("verify_code_"+userModel.getId(),10,TimeUnit.MINUTES);

        ImageIO.write((RenderedImage) map.get("codePic"), "jpeg", response.getOutputStream());
    }
```

在生成秒杀令牌前，验证验证码是否有效

```java
//通过verifyCode验证验证码的有效性
        String verifyCodeInRedis = (String) redisTemplate.opsForValue().get("verify_code_"+userModel.getId());
        if (StringUtils.isEmpty(verifyCodeInRedis)){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"请求非法");
        }
        if (!verifyCodeInRedis.equalsIgnoreCase(verifyCode)){
            throw new BusinessException(EmBusinessError.PARAMETER_VAILDATION_ERROR,"验证码错误");
        }
```

在前端页面上新添加一个验证按钮并绑定事件

```html
<div id="verifyDiv" style="display:none;" class="form-actions">
        <img src=""/>
        <input type="text" id="verifyContent" value=""/>
        <button class="btn blue" id="verifyButton" type="submit">
            验证
        </button>
    </div>

```

```javascript
$("#verifyButton").on("click", function () {
            var token = window.localStorage["token"];
            $.ajax({
                type:"POST",
                contentType:"application/x-www-form-urlencoded",
                url:"http://"+g_host+"/order/generatetoken?token="+token,
                data:{
                    "itemId":g_itemVO.id,
                    "promoId":g_itemVO.promoId,
                    "verifyCode":$("#verifyContent").val()
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status == "success"){
                        var promoToken = data.data;
                        $.ajax({
                            type:"POST",
                            contentType:"application/x-www-form-urlencoded",
                            url:"http://"+g_host+"/order/createorder?token="+token,
                            data:{
                                "itemId":g_itemVO.id,
                                "amount":1,
                                "promoId":g_itemVO.promoId,
                                "promoToken":promoToken
                            },
                            xhrFields:{withCredentials:true},
                            success:function(data){
                                if (data.status == "success"){
                                    alert("下单成功！");
                                    //刷新界面
                                    window.location.reload();
                                }else {
                                    alert("下单失败，原因为"+data.data.errMsg );
                                    if (data.data.errCode == 20003){
                                        window.location.href = "login.html";
                                    }

                                }
                            },
                            error:function (data) {
                                alert("下单失败，原因为"+data.responseText);
                            }
                        })
                    }else {
                        alert("获取令牌失败，原因为"+data.data.errMsg );
                        if (data.data.errCode == 20003){
                            window.location.href = "login.html";
                        }
                    }
                },
                error:function (data) {
                    alert("获取令牌失败，原因为"+data.responseText);
                }
            })
        })
        $("#createorder").on("click", function () {
			var token = window.localStorage["token"];
			if(token == null){
				alert("没有登录，不能下单");
				window.location.href="login.html";
				return false;
			}
			$("#verifyDiv img").attr("src","http://"+g_host+"/order/generateverifycode?token="+token);
			$("#verifyDiv").show();
        });
```



### 12.2、限流技术

使用guava类的RateLimiter对象，并在init方法中初始化，当每秒访问量大于300，就开始限流

```java
private RateLimiter orderCreateRateLimiter;
@PostConstruct
    public void init(){
        executorService = Executors.newFixedThreadPool(20);

        orderCreateRateLimiter.create(300);
    }
```

在createOrder时，第一步就判断是否超过300，如果超过就抛出异常

```java
if (!orderCreateRateLimiter.tryAcquire()){
            throw new BusinessException(EmBusinessError.RATELIMIT);
        }
```



## 十三、数据库与缓存的一致性问题

### 1、缓存的读取方式

一般Redis缓存的读取步骤如下：

① 数据访问服务先读取缓存，查找所要查找的数据；

②缓存查找成功，则直接返回；查找失败则继续查找数据库；

③查找数据库数据成功后，**将查找数据写入缓存中**从而方便之后相同数据的查找。

### 2、缓存的更新模式

当用户要更新数据库的数据时，就需要对于Redis的缓存进行更新，对于缓存的更新有以下几种不同的方式。

#### 方式1：先更新缓存，再更新数据库

这种方式下，假如用户在更新了缓存数据后，更新数据库失败了，那么就会导致缓存数据和数据库数据不一致的情况。

![image-20210825210959476](C:\Users\SunDongHai\AppData\Roaming\Typora\typora-user-images\image-20210825210959476.png)

如果在A用户查找一条数据D1(旧数据)时，缓存中没有查找到数据D1；在A没查到缓存之后，B用户需要更新数据D1，B先更新缓存数据D1(新数据)；B更新缓存之后，A用户才去数据库查找该数据并且查找到了数据D1(旧数据)，将D1(旧数据)写入缓存中；A查找到数据之后，B(因为上边讲的六种缓存和读取数据库中间时间过长的原因)才开始更新数据库，将D1(新数据)更新到数据库中。这样就又造成了数据不一致的状况

#### 方式2：先更新数据库，再更新缓存

这种方式下，数据的更新更加可靠，因为数据库更新成功，数据时持久存在的。但是有一种情况，数据库更新成功，缓存更新失败，下一次用户来读取数据时，先读取缓存读到的是旧数据，还是会出现数据不一致的情况；如果数据库更新成功，即使缓存服务出现异常，其他用户读取同样的数据时会在读取数据库后来更新缓存的数据；

下面我们来介绍一种此模式下数据不一致的情况：

用户A去更新了数据库的数据D1(A修改后的数据)后，用户B又更新了数据库的数据D1(B修改后的数据)，接着又更新了缓存中的数据D1(B修改后的数据)；在B更新了缓存中的数据D1后，此时用户A才更新缓存中的数据D1(A修改后的数据)。这样一来，B用户覆盖了A用户更新在数据库的数据，A用户覆盖了B用户在缓存中更新的数据，导致了缓存和数据库的数据又出现不一致情况。

#### 为什么秒杀项目使用的是先更新缓存，再更新数据的方式？

**原则：宁可少卖，不能超卖**

先更新缓存，再更新数据：如果在更新数据库中库存时出现了问题，缓存中的库存已经被扣减，数据库的数据会回滚。假设原来Redis和mysql中库存都是50，有一个下单请求过来，Redis中数据修改为49，而mysql更新时出现了问题，mysql中的库存数据还是50，之后如果不出问题，当Redis中库存为0时，mysql中还有1个库存，出现了少卖问题。

先更新数据，再更新缓存：如果在更新缓存时出了问题，Redis更新失败，会出现超卖的现象，这对秒杀的业务来说是不可以接受的错误。

- 通过消息队列实现异步更新
  数据访问服务的所有读操作都来读Redis缓存，而所有的写操作都直接通过数据库来进行操作。然后在数据库和缓存之间增加一个`数据同步服务`，定时的将数据库的数据同步到Redis缓存中。**这里有一个弊端就是，Redis缓存的容量也会随数据库数据量的增大而增大**。

  #### 异步更新缓存（基于订阅binlog的同步机制）

  通过异步更新缓存将缓存与数据库的一致性同步从业务中独立出来统一处理，保证数据一致性

  整体技术思路：

  1. 读Redis：热数据基本都在Redis
  2. 写MySQL:增删改都是操作MySQL
  3. 更新Redis数据：订阅MySQ的数据操作记录binlog，来更新到Redis

  数据操作分为两大部分：

  - 全量更新（将全部数据一次性写入redis）
  - 增量更新（实时更新）

  这样一旦MySQL中产生了新的写入、更新、删除等操作，就可以把binlog相关的消息通过消息队列推送至Redis，Redis再根据binlog中的记录，对Redis进行更新。

### 3、缓存的删除模式

#### 方式1：先删除缓存，再更新数据库

这种方式在正常的情况下，使数据的读取更加及时有效。因为它能在用户更新的第一时间删除掉旧的缓存数据，将最新数据更新到数据库中去，但是它会造成读取数据库的压力变大。如果删除缓存数据不成功，则会造成用户读取的缓存数据为旧数据，这样就会造成数据的不一致情况。

下面我们来介绍一种此模式下数据不一致的情况：

用户A去更新数据D1时，先删除了缓存中的数据D1;然后此时用户B来读取数据D1时，查询缓存中没有D1数据，然后就去数据库查询到了数据D1(旧的数据D1)，随后将数据D1重新写入缓存中(旧数据)；这时(由于上文提到的6种原因)，用户A才去更新数据库的D1数据(A修改后的数据)，这样就造成了数据不一致的情况。

**解决办法：延时双删**

先删除缓存，再更新数据库，之后再删除缓存，将新的数据写入缓存

#### 方式2：先更新数据库，再删除缓存

这种方式能够及时的将最新数据更新到数据库中，能够保证持久化数据更新的及时性。但是用户读取数据时，可能读取的数据不是最新的；如果用户再更新数据时没有删除缓存成功，也会造成缓存中的数据不是最新的数据。

下面我们来介绍一种此模式下数据不一致的情况：

用户A来读取数据D1，因为缓存失效的原因读取Redis缓存没有找到D1数据，然后读取了数据库中的数据D1;此时，用户B来更新数据D1，他先更新了数据库的数据D1(用户B更改后的)，然后删除了缓存中的数据；这时，用户A才对缓存进行写入操作，但它的缓存却是旧数据D1的缓存，这样就又造成了数据不一致的情况